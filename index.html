<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Craft.io â€” Survive & Conquer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PIXEL ART RPG â€” VARIÃVEIS GLOBAIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --px:2px; /* pixel base */
  --gold:#f0d060;--gold2:#c0a020;
  --dark:#1a1208;--darker:#0d0a04;
  --panel:rgba(18,12,4,.97);
  --border:#6b4a18;--border2:#9b7a30;
  --hp-col:#e03030;--hunger-col:#d07010;--water-col:#2080d0;--xp-col:#8040e0;
  --grass-light:#5a9a28;--grass-mid:#487a20;--grass-dark:#386018;
  --stone-light:#9a9a8a;--stone-mid:#787870;--stone-dark:#585850;
  --wood-light:#b87a3a;--wood-mid:#8b5a20;--wood-dark:#6b3a10;
  --water-light:#4a90c0;--water-mid:#2a70a0;--water-dark:#1a5080;
  --sand-light:#e0c878;--sand-mid:#c8a850;--sand-dark:#a88838;
  --snow-light:#e8f0f8;--snow-mid:#c8d8e8;--snow-dark:#a8b8c8;
  --ui-bg:#1e150a;--ui-panel:#2a1c0e;--ui-border:#5a3a14;
  --ui-border-light:#8a5a24;--ui-text:#f0d890;--ui-dim:#a08040;
}

/* Rendering pixel-perfeito */
canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}

*{margin:0;padding:0;box-sizing:border-box}
body{
  background:var(--darker);overflow:hidden;
  font-family:'Press Start 2P',monospace;
  color:var(--ui-text);user-select:none;cursor:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURSOR PIXEL ART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cursor{
  position:fixed;pointer-events:none;z-index:99999;
  width:16px;height:16px;transform:translate(-2px,-2px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TELA DE LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen{
  position:fixed;inset:0;z-index:9999;overflow:hidden;
  background:#1a1208;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;
}
#login-bg-canvas{position:absolute;inset:0;width:100%;height:100%;image-rendering:pixelated}

.login-ui{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:16px}

/* TÃ­tulo pixel art */
.logo-pixel{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(1.8rem,5vw,3.5rem);
  color:#f0d060;
  text-shadow:
    4px 4px 0 #6b3a00,
    -2px -2px 0 #000,
    2px -2px 0 #000,
    -2px 2px 0 #000,
    0 4px 0 #3a2000;
  letter-spacing:4px;
  animation:pixelBob 2s ease-in-out infinite;
  margin-bottom:4px;
}
@keyframes pixelBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

.logo-sub-pixel{
  font-family:'VT323',monospace;font-size:1.4rem;
  color:#a08040;letter-spacing:3px;margin-bottom:20px;
}

/* Caixa de login estilo RPG */
.login-box{
  background:var(--ui-bg);
  border:4px solid var(--border);
  outline:2px solid var(--border2);
  padding:28px 36px;
  display:flex;flex-direction:column;gap:14px;min-width:360px;
  position:relative;
  box-shadow:8px 8px 0 rgba(0,0,0,.8),inset 0 0 0 2px rgba(0,0,0,.5);
}
/* Cantos do frame RPG */
.login-box::before,.login-box::after{
  content:'';position:absolute;width:12px;height:12px;
  background:var(--border2);
}
.login-box::before{top:-2px;left:-2px}
.login-box::after{bottom:-2px;right:-2px}

.login-box label{
  font-family:'Press Start 2P',monospace;
  font-size:.5rem;color:var(--ui-dim);letter-spacing:2px;
}
.login-box input{
  background:#0d0a04;border:2px solid var(--border);
  color:var(--gold);font-family:'VT323',monospace;
  font-size:1.4rem;padding:10px 14px;outline:none;transition:.15s;
  letter-spacing:2px;
  box-shadow:inset 2px 2px 0 rgba(0,0,0,.5);
}
.login-box input:focus{border-color:var(--border2);background:#1a1208}

.btn-enter{
  background:var(--wood-mid);
  border:3px solid var(--border2);
  color:#fff8e0;font-family:'Press Start 2P',monospace;
  font-size:.55rem;padding:14px 8px;cursor:pointer;letter-spacing:2px;
  transition:.1s;position:relative;
  box-shadow:4px 4px 0 rgba(0,0,0,.7);
  text-shadow:2px 2px 0 #000;
}
.btn-enter:hover{transform:translate(-2px,-2px);box-shadow:6px 6px 0 rgba(0,0,0,.7);background:var(--wood-light)}
.btn-enter:active{transform:translate(2px,2px);box-shadow:2px 2px 0 rgba(0,0,0,.7)}

.login-info{font-family:'VT323',monospace;font-size:.9rem;color:#5a4020;letter-spacing:1px;text-align:center}
.online-badge{
  background:#0d1a08;border:2px solid #2a5a1a;
  padding:6px 14px;color:#4aaa2a;
  font-family:'VT323',monospace;font-size:1rem;letter-spacing:2px;text-align:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameCanvas{display:block;position:fixed;inset:0}
#interior-canvas{display:none;position:fixed;inset:0;z-index:200}
#interior-canvas.open{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD â€” ESTILO RPG PIXEL ART
   PainÃ©is com bordas de pixel, fontes bitmap
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud{position:fixed;inset:0;pointer-events:none;z-index:100;display:none}

/* Mixin de painel RPG */
.rpg-panel{
  background:var(--ui-bg);
  border:3px solid var(--border);
  outline:1px solid var(--border2);
  box-shadow:4px 4px 0 rgba(0,0,0,.8);
  position:relative;
}
.rpg-panel::before{
  content:'';position:absolute;inset:2px;
  border:1px solid rgba(255,200,100,.06);pointer-events:none;
}

/* â”€â”€ COORDS â”€â”€ */
#coords{
  position:absolute;top:12px;left:12px;
  padding:8px 12px;
  font-family:'VT323',monospace;font-size:1rem;color:var(--ui-dim);
  line-height:1.8;letter-spacing:1px;min-width:150px;
}
#coords span{color:var(--gold)}
.biome-tag{
  display:inline-block;
  background:#0d1208;border:1px solid #2a3a18;
  padding:1px 6px;font-size:.75rem;color:#80b040;
  margin-top:3px;letter-spacing:1px;
}

/* â”€â”€ PLAYER PANEL â”€â”€ */
#player-panel{
  position:absolute;top:12px;left:190px;
  padding:10px 14px;min-width:200px;
}
.pp-class{display:flex;align-items:center;gap:10px;margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid var(--border)}
.pp-avatar{
  width:40px;height:40px;border:2px solid var(--border2);
  background:#0d0a04;flex-shrink:0;
  image-rendering:pixelated;
  box-shadow:inset 2px 2px 0 rgba(0,0,0,.5);
}
.pp-class-name{
  color:var(--gold);font-size:.5rem;letter-spacing:1px;display:block;
  text-shadow:2px 2px 0 #000;
}
.pp-class-desc{font-family:'VT323',monospace;font-size:.85rem;color:#8a6030;display:block;margin-top:3px}
.pp-row{
  display:flex;justify-content:space-between;
  font-family:'VT323',monospace;font-size:.9rem;color:var(--ui-dim);
  line-height:2;letter-spacing:1px;
}
.pp-val{color:var(--ui-text)}
.pp-bar-lbl{font-family:'VT323',monospace;font-size:.75rem;color:#6a4a18;letter-spacing:1px;margin-top:4px;margin-bottom:2px}
.pp-bar{width:100%;height:6px;background:#08060400;border:2px solid var(--border);overflow:hidden;image-rendering:pixelated}
.pp-bar-fill{height:100%;background:linear-gradient(90deg,#cc1111,#ff3333,#ff8844);transition:width .4s}

/* â”€â”€ BARRAS DE STATUS â”€â”€ */
#bars{
  position:absolute;bottom:130px;left:50%;transform:translateX(-50%);
  display:flex;flex-direction:column;gap:4px;pointer-events:none;
  align-items:center;
}
.bar-row{display:flex;align-items:center;gap:6px}
.bar-label{
  font-family:'Press Start 2P',monospace;font-size:.38rem;
  color:var(--ui-dim);width:60px;text-align:right;letter-spacing:0;
}
.bar-bg{
  width:180px;height:12px;
  background:#0d0a04;border:2px solid var(--border);
  overflow:hidden;image-rendering:pixelated;
  box-shadow:inset 2px 2px 0 rgba(0,0,0,.5);
}
/* Efeito "pixel chunks" nas barras */
.bar-fill{
  height:100%;transition:width .3s;
  position:relative;
}
.bar-fill::after{
  content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(90deg,transparent 0,transparent 10px,rgba(0,0,0,.2) 10px,rgba(0,0,0,.2) 12px);
}
#hp-fill{background:#cc2222}
#hunger-fill{background:#cc7000}
#water-fill{background:#1a70c0}
#xp-fill{background:#6020c0}
.bar-val{font-family:'VT323',monospace;font-size:.9rem;color:#6a5020;width:36px}

/* â”€â”€ HOTBAR â”€â”€ */
#hotbar{
  position:absolute;bottom:54px;left:50%;transform:translateX(-50%);
  display:flex;gap:3px;pointer-events:all;
}
.slot{
  width:54px;height:54px;
  background:var(--ui-bg);
  border:3px solid var(--border);
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;transition:.1s;position:relative;overflow:hidden;
  box-shadow:3px 3px 0 rgba(0,0,0,.8);
  image-rendering:pixelated;
}
.slot:hover{border-color:var(--border2);transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(0,0,0,.8)}
.slot.active{
  border-color:var(--gold);
  background:#2a1c04;
  box-shadow:3px 3px 0 rgba(0,0,0,.8),inset 0 0 0 1px rgba(240,192,0,.2);
}
.slot .item-icon{font-size:1.5rem;line-height:1;image-rendering:pixelated}
.slot .item-count{
  position:absolute;bottom:1px;right:2px;
  font-family:'Press Start 2P',monospace;font-size:.38rem;
  color:var(--ui-text);text-shadow:1px 1px 0 #000;
}
.slot-num{
  position:absolute;top:1px;left:3px;
  font-family:'Press Start 2P',monospace;font-size:.32rem;color:#4a3010;
}

/* â”€â”€ LEADERBOARD â”€â”€ */
#leaderboard{
  position:absolute;top:12px;right:180px;
  padding:10px 12px;min-width:180px;
}
#leaderboard h4{
  font-size:.42rem;color:var(--gold);letter-spacing:2px;
  margin-bottom:8px;text-align:center;
  padding-bottom:5px;border-bottom:2px solid var(--border);
  text-shadow:2px 2px 0 #000;
}
.lb-row{
  display:flex;align-items:center;gap:5px;
  font-family:'VT323',monospace;font-size:.9rem;color:var(--ui-dim);
  line-height:1.9;letter-spacing:1px;
}
.lb-row.lb-me{color:var(--gold);background:rgba(240,192,0,.06);padding:0 2px}
.lb-rank{color:#4a3010;width:16px;font-size:.75rem}
.lb-score{color:#6a5020;font-size:.75rem}

/* â”€â”€ MINIMAP â”€â”€ */
#minimap-wrap{
  position:absolute;top:12px;right:12px;
  padding:7px 7px 4px;
}
#minimap-wrap h4{
  font-size:.32rem;color:var(--ui-dim);text-align:center;
  margin-bottom:5px;letter-spacing:2px;
}
#minimap{width:152px;height:152px;border:2px solid var(--border);image-rendering:pixelated}

/* â”€â”€ NOTIFICAÃ‡Ã•ES â”€â”€ */
#notifs{
  position:absolute;right:12px;top:240px;
  display:flex;flex-direction:column;gap:4px;
  pointer-events:none;width:220px;
}
.notif{
  background:var(--ui-bg);border:2px solid var(--border);border-right:4px solid var(--border2);
  padding:6px 10px;
  font-family:'VT323',monospace;font-size:.95rem;color:var(--ui-text);
  letter-spacing:.5px;text-align:right;
  animation:notifSlide .2s steps(3),notifFade .3s 2.5s steps(3) forwards;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  box-shadow:3px 3px 0 rgba(0,0,0,.7);
}
.notif.kill{border-right-color:#ff2222;color:#ff9999}
.notif.lv{border-right-color:#ffdd00;color:#ffeeaa}
.notif.craft{border-right-color:#44ff44;color:#aaffaa}
.notif.dmg{border-right-color:#ff6600;color:#ffcc88}
.notif.water{border-right-color:#44aaff;color:#88ccff}
.notif.loot{border-right-color:#44aaff;color:#88ccff}
@keyframes notifSlide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes notifFade{to{opacity:0}}

/* â”€â”€ CHAT â”€â”€ */
#chat-box{position:absolute;bottom:124px;left:12px;width:280px;pointer-events:all}
#chat-msgs{max-height:100px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;margin-bottom:4px}
.chat-msg{
  font-family:'VT323',monospace;font-size:.9rem;color:#a08040;
  letter-spacing:.3px;line-height:1.5;
}
.chat-msg .cn{color:var(--gold)}
.chat-msg.sys{color:#4a7a2a;font-style:italic}
.chat-msg.pvp{color:#cc4422}
.chat-msg.loot{color:#4488cc}
#chat-input-row{display:flex;gap:3px}
#chat-input{
  flex:1;background:#0d0a04;border:2px solid var(--border);color:var(--gold);
  font-family:'VT323',monospace;font-size:1rem;padding:6px 8px;outline:none;
  letter-spacing:.5px;box-shadow:inset 2px 2px 0 rgba(0,0,0,.4);
}
#chat-input:focus{border-color:var(--border2)}
#chat-send{
  background:var(--wood-dark);border:2px solid var(--border);color:var(--ui-dim);
  font-family:'VT323',monospace;font-size:1rem;padding:6px 10px;cursor:pointer;
  box-shadow:2px 2px 0 rgba(0,0,0,.6);transition:.1s;
}
#chat-send:hover{background:var(--wood-mid);border-color:var(--border2)}

/* â”€â”€ BOTÃ•ES HUD â”€â”€ */
#hud-btns{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  display:flex;gap:4px;pointer-events:all;
}
.hud-btn{
  background:var(--ui-panel);border:2px solid var(--border);
  color:var(--ui-dim);font-family:'Press Start 2P',monospace;
  font-size:.35rem;padding:7px 10px;cursor:pointer;letter-spacing:1px;
  transition:.1s;box-shadow:3px 3px 0 rgba(0,0,0,.7);
  text-shadow:1px 1px 0 #000;
}
.hud-btn:hover{border-color:var(--border2);color:var(--gold);transform:translate(-1px,-1px);box-shadow:4px 4px 0 rgba(0,0,0,.7)}
.hud-btn:active{transform:translate(1px,1px);box-shadow:2px 2px 0 rgba(0,0,0,.7)}

/* â”€â”€ TOOLTIP â”€â”€ */
#tooltip{
  display:none;position:fixed;
  background:var(--ui-bg);border:3px solid var(--border);outline:1px solid var(--border2);
  padding:10px 14px;font-family:'VT323',monospace;font-size:1rem;
  color:var(--ui-text);pointer-events:none;z-index:9999;max-width:200px;
  line-height:1.8;box-shadow:4px 4px 0 rgba(0,0,0,.8);letter-spacing:.5px;
}
#tooltip h5{color:var(--gold);font-size:.45rem;font-family:'Press Start 2P',monospace;margin-bottom:6px;padding-bottom:4px;border-bottom:2px solid var(--border)}
#tooltip .tstat{color:#80c040}
#tooltip .tcr{color:#4080cc}

/* â”€â”€ BUILD PANEL â”€â”€ */
#build-panel{
  display:none;position:absolute;right:180px;top:50%;transform:translateY(-50%);
  padding:12px;pointer-events:all;z-index:200;
}
#build-panel.open{display:block}
#build-panel h4{font-size:.38rem;color:var(--gold);letter-spacing:1px;margin-bottom:8px;text-align:center;text-shadow:2px 2px 0 #000}
.build-grid{display:grid;grid-template-columns:repeat(3,52px);gap:3px}
.build-slot{
  width:52px;height:52px;background:var(--ui-bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;transition:.1s;position:relative;
  box-shadow:2px 2px 0 rgba(0,0,0,.7);
}
.build-slot:hover{border-color:var(--border2);transform:translate(-1px,-1px)}
.build-slot.sel{border-color:var(--gold);background:#2a1c04}
.build-slot .item-icon{font-size:1.3rem;image-rendering:pixelated}
.build-slot .bcount{position:absolute;bottom:1px;right:2px;font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--ui-text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVENTÃRIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#inventory-screen{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.85);
  align-items:center;justify-content:center;pointer-events:all;
}
#inventory-screen.open{display:flex}
.inv-panel{
  background:var(--ui-bg);border:4px solid var(--border);outline:2px solid var(--border2);
  padding:20px;width:min(680px,96vw);max-height:88vh;overflow-y:auto;
  box-shadow:8px 8px 0 rgba(0,0,0,.9);
}
.inv-panel h2{
  font-size:.6rem;color:var(--gold);letter-spacing:3px;margin-bottom:14px;
  text-align:center;text-shadow:3px 3px 0 #000;padding-bottom:8px;
  border-bottom:3px solid var(--border);
}
.inv-tabs{display:flex;gap:3px;margin-bottom:10px;flex-wrap:wrap}
.inv-tab{
  background:#0d0a04;border:2px solid var(--border);color:var(--ui-dim);
  font-family:'Press Start 2P',monospace;font-size:.35rem;padding:7px 10px;
  cursor:pointer;letter-spacing:1px;transition:.1s;
  box-shadow:2px 2px 0 rgba(0,0,0,.6);
}
.inv-tab.active{background:var(--ui-panel);border-color:var(--border2);color:var(--gold)}
.inv-tab:hover{border-color:var(--border2)}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,56px);gap:4px}
.inv-slot{
  width:56px;height:56px;background:#0d0a04;border:2px solid #2a1a08;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;transition:.1s;position:relative;
  box-shadow:inset 2px 2px 0 rgba(0,0,0,.4);
}
.inv-slot:hover{border-color:var(--border2);background:#1a1208}
.inv-slot.empty{border-color:#160e04;cursor:default}
.inv-slot .item-icon{font-size:1.5rem;image-rendering:pixelated}
.inv-slot .item-count{
  position:absolute;bottom:1px;right:2px;
  font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--ui-text);
  text-shadow:1px 1px 0 #000;
}
.inv-slot .item-name{font-family:'VT323',monospace;font-size:.7rem;color:#4a3010;text-align:center;line-height:1.1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRAFT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#craft-screen{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.85);align-items:center;justify-content:center;pointer-events:all;
}
#craft-screen.open{display:flex}
.craft-panel{
  background:var(--ui-bg);border:4px solid var(--border);outline:2px solid var(--border2);
  padding:20px;width:min(780px,96vw);max-height:90vh;overflow-y:auto;
  box-shadow:8px 8px 0 rgba(0,0,0,.9);
}
.craft-panel h2{font-size:.6rem;color:var(--gold);letter-spacing:3px;margin-bottom:12px;text-align:center;text-shadow:3px 3px 0 #000;padding-bottom:8px;border-bottom:3px solid var(--border)}
.craft-search{
  width:100%;background:#0d0a04;border:2px solid var(--border);color:var(--gold);
  font-family:'VT323',monospace;font-size:1.1rem;padding:8px 12px;outline:none;
  margin-bottom:8px;letter-spacing:.8px;box-shadow:inset 2px 2px 0 rgba(0,0,0,.4);
}
.craft-search:focus{border-color:var(--border2)}
.craft-cats{display:flex;gap:3px;margin-bottom:10px;flex-wrap:wrap}
.craft-cat{background:#0d0a04;border:2px solid var(--border);color:var(--ui-dim);font-family:'Press Start 2P',monospace;font-size:.32rem;padding:6px 9px;cursor:pointer;letter-spacing:1px;transition:.1s;box-shadow:2px 2px 0 rgba(0,0,0,.5)}
.craft-cat.active{background:var(--ui-panel);border-color:var(--border2);color:var(--gold)}
.craft-cat:hover{border-color:var(--border2)}
.craft-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:6px}
.craft-item{
  background:#0d0a04;border:2px solid #2a1a08;padding:10px;cursor:pointer;
  transition:.1s;display:flex;gap:8px;align-items:flex-start;
  box-shadow:2px 2px 0 rgba(0,0,0,.6);
}
.craft-item:hover{border-color:var(--border)}
.craft-item.can{border-color:#285018}
.craft-item.can:hover{border-color:#4a8030}
.craft-icon{font-size:1.8rem;width:36px;text-align:center;flex-shrink:0;image-rendering:pixelated}
.craft-info h4{font-family:'Press Start 2P',monospace;font-size:.38rem;color:var(--ui-text);letter-spacing:.5px;margin-bottom:4px}
.craft-reqs{font-family:'VT323',monospace;font-size:.85rem;color:var(--ui-dim);line-height:1.8}
.craft-reqs .has{color:#4a9030}.craft-reqs .lacks{color:#aa3322}
.craft-do{
  background:#1a3010;border:2px solid #2a5020;color:#80c040;
  font-family:'Press Start 2P',monospace;font-size:.32rem;padding:5px 8px;
  cursor:pointer;letter-spacing:.5px;margin-top:5px;transition:.1s;
  box-shadow:2px 2px 0 rgba(0,0,0,.5);
}
.craft-do:hover:not(:disabled){background:#2a4020;border-color:#4a7030}
.craft-do:disabled{opacity:.3;cursor:not-allowed}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INTERIOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#interior-label{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-300%);
  background:var(--ui-bg);border:3px solid var(--border2);
  padding:8px 20px;
  font-family:'Press Start 2P',monospace;font-size:.5rem;color:var(--gold);
  letter-spacing:2px;pointer-events:none;z-index:360;white-space:nowrap;
  opacity:0;transition:.3s;box-shadow:4px 4px 0 rgba(0,0,0,.8);text-shadow:2px 2px 0 #000;
}
#interior-label.show{opacity:1;transform:translate(-50%,-250%)}
#exit-btn{
  display:none;position:fixed;bottom:76px;left:50%;transform:translateX(-50%);
  z-index:360;background:#2a0808;border:3px solid #7a1818;
  color:#ffaaaa;font-family:'Press Start 2P',monospace;
  font-size:.4rem;padding:10px 20px;cursor:pointer;
  letter-spacing:2px;pointer-events:all;transition:.1s;
  box-shadow:4px 4px 0 rgba(0,0,0,.8);text-shadow:2px 2px 0 #000;
}
#exit-btn.show{display:block}
#exit-btn:hover{background:#3a1010;border-color:#aa2222;transform:translateX(-50%) translate(-1px,-1px)}

/* â”€â”€ BAÃš â”€â”€ */
.chest-loot{
  display:none;position:fixed;z-index:400;
  background:var(--ui-bg);border:4px solid var(--border);outline:2px solid var(--border2);
  padding:16px;min-width:300px;pointer-events:all;
  box-shadow:6px 6px 0 rgba(0,0,0,.9);
}
.chest-loot.open,.chest-loot[style*="block"]{display:block}
.chest-loot h4{
  font-size:.42rem;color:var(--gold);letter-spacing:2px;margin-bottom:10px;
  text-align:center;border-bottom:2px solid var(--border);padding-bottom:6px;
  text-shadow:2px 2px 0 #000;
}
.chest-grid{display:grid;grid-template-columns:repeat(5,48px);gap:3px}
.chest-slot{
  width:48px;height:48px;background:#0d0a04;border:2px solid #2a1a08;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;transition:.1s;position:relative;
  box-shadow:inset 2px 2px 0 rgba(0,0,0,.4);
}
.chest-slot:hover{border-color:var(--gold)}
.chest-slot .item-icon{font-size:1.3rem;image-rendering:pixelated}
.chest-slot .item-count{position:absolute;bottom:1px;right:2px;font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--ui-text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MORTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#death-screen{
  display:none;position:fixed;inset:0;z-index:800;
  background:rgba(0,0,0,.88);
  align-items:center;justify-content:center;flex-direction:column;gap:20px;pointer-events:all;
}
#death-screen.show{display:flex}
#death-screen h2{
  font-size:clamp(1rem,4vw,1.8rem);color:#cc0000;
  text-shadow:4px 4px 0 #440000,-2px -2px 0 #000;
  animation:deathFlicker 0.5s steps(2) infinite;letter-spacing:4px;
}
@keyframes deathFlicker{0%{opacity:1}50%{opacity:.4}}
#death-screen p{font-family:'VT323',monospace;font-size:1.2rem;color:#884444;letter-spacing:2px}
#respawn-btn{
  background:#1a0808;border:3px solid #aa1111;color:#ffaaaa;
  font-family:'Press Start 2P',monospace;font-size:.5rem;padding:14px 28px;cursor:pointer;
  letter-spacing:2px;transition:.1s;box-shadow:4px 4px 0 rgba(0,0,0,.8);text-shadow:2px 2px 0 #000;
}
#respawn-btn:hover{background:#2a1010;box-shadow:6px 6px 0 rgba(0,0,0,.8);transform:translate(-1px,-1px)}

/* â”€â”€ CLASS POPUP â”€â”€ */
#class-popup{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  z-index:900;background:var(--ui-bg);border:4px solid var(--gold);outline:2px solid var(--border2);
  padding:28px 40px;text-align:center;pointer-events:none;
  box-shadow:8px 8px 0 rgba(0,0,0,.9);
  animation:classPopIn .4s steps(6) forwards;
}
@keyframes classPopIn{from{opacity:0;transform:translate(-50%,-50%) scale(.5)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
#class-popup .cp-canvas{margin:0 auto 12px;display:block;image-rendering:pixelated}
#class-popup .cp-title{font-size:.55rem;color:var(--gold);letter-spacing:3px;margin-bottom:4px;text-shadow:3px 3px 0 #000}
#class-popup .cp-name{font-family:'VT323',monospace;font-size:1.4rem;color:#f0d8ff;letter-spacing:2px}
#class-popup .cp-desc{font-family:'VT323',monospace;font-size:1rem;color:#7060a0;margin-top:6px}

/* â”€â”€ WATER ALERT â”€â”€ */
#water-alert{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  z-index:700;background:#0a1428;border:3px solid #1a60a0;
  padding:12px 24px;text-align:center;pointer-events:none;
  box-shadow:4px 4px 0 rgba(0,0,0,.8);
  animation:waterFlicker .8s steps(2) infinite;
}
#water-alert.show{display:block}
@keyframes waterFlicker{0%{border-color:#1a60a0}50%{border-color:#4090d0}}
#water-alert p{font-family:'VT323',monospace;color:#4488ff;font-size:1.1rem;letter-spacing:2px}

/* â”€â”€ CLOSE BTN â”€â”€ */
.close-btn{
  background:#0d0a04;border:2px solid var(--border);color:var(--ui-dim);
  font-family:'Press Start 2P',monospace;font-size:.4rem;padding:8px 16px;
  cursor:pointer;letter-spacing:2px;transition:.1s;margin-top:12px;
  box-shadow:3px 3px 0 rgba(0,0,0,.7);
}
.close-btn:hover{border-color:var(--border2);color:var(--gold);transform:translate(-1px,-1px)}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#0d0a04}
::-webkit-scrollbar-thumb{background:var(--border);image-rendering:pixelated}
</style>
</head>
<body>

<!-- CURSOR PIXEL ART -->
<canvas id="cursor" width="16" height="16"></canvas>

<!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <canvas id="login-bg-canvas"></canvas>
  <div class="login-ui">
    <div style="font-family:'Press Start 2P',monospace;font-size:clamp(1.5rem,4vw,3rem);color:#f0d060;text-shadow:4px 4px 0 #6b3a00,-2px -2px 0 #000;letter-spacing:4px;animation:pixelBob 2s ease-in-out infinite;margin-bottom:4px">âš” CRAFT.IO âš”</div>
    <div style="font-family:'VT323',monospace;font-size:1.3rem;color:#8a6030;letter-spacing:3px;margin-bottom:18px">SOBREVIVA Â· CONQUISTE Â· LENDE</div>
    <div class="login-box rpg-panel">
      <div class="online-badge" id="online-badge">Â» CONECTANDO... Â«</div>
      <label>â–¶ NOME DO HERÃ“I</label>
      <input type="text" id="player-name-input" placeholder="Seu nome lendÃ¡rio..." maxlength="18" autofocus/>
      <button class="btn-enter" id="btn-enter" onclick="enterGame()">â–¶ ADENTRAR O MUNDO</button>
      <div class="login-info">WASDÂ·Mover | CLICKÂ·Atacar | EÂ·Inv | CÂ·Craft | FÂ·Entrar | TÂ·Chat</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â•â•â•â• -->
<canvas id="gameCanvas"></canvas>
<canvas id="interior-canvas"></canvas>
<div id="interior-label"></div>
<button id="exit-btn" onclick="exitBuilding()">â–² SAIR [F]</button>

<!-- â•â•â•â•â•â•â•â•â•â• HUD â•â•â•â•â•â•â•â•â•â• -->
<div id="hud">
  <div id="coords" class="rpg-panel">
    X:<span id="cx">0</span> Y:<span id="cy">0</span>
    <br><span id="biome-tag" class="biome-tag">PlanÃ­cies</span>
    <br>Dia <span id="day-num">1</span> <span id="time-str">â˜€</span>
  </div>

  <div id="player-panel" class="rpg-panel">
    <div class="pp-class">
      <canvas id="avatar-canvas" class="pp-avatar" width="40" height="40"></canvas>
      <div>
        <span class="pp-class-name" id="pp-name">AldeÃ£o</span>
        <span class="pp-class-desc" id="pp-desc">InÃ­cio da jornada</span>
      </div>
    </div>
    <div class="pp-row"><span>Kills</span><span class="pp-val" id="pp-kills">0</span></div>
    <div class="pp-row"><span>Mortes</span><span class="pp-val" id="pp-deaths">0</span></div>
    <div class="pp-row"><span>PrÃ³x.</span><span class="pp-val" id="pp-next">5 kills</span></div>
    <div class="pp-bar-lbl">PROGRESSO</div>
    <div class="pp-bar"><div class="pp-bar-fill" id="pp-bar-fill" style="width:0%"></div></div>
  </div>

  <div id="bars">
    <div class="bar-row"><span class="bar-label">â¤ VIDA</span><div class="bar-bg"><div class="bar-fill" id="hp-fill" style="width:100%"></div></div><span class="bar-val" id="hp-val">80</span></div>
    <div class="bar-row"><span class="bar-label">ğŸ– FOME</span><div class="bar-bg"><div class="bar-fill" id="hunger-fill" style="width:100%"></div></div><span class="bar-val" id="hunger-val">100</span></div>
    <div class="bar-row"><span class="bar-label">ğŸ’§ ÃGUA</span><div class="bar-bg"><div class="bar-fill" id="water-fill" style="width:100%"></div></div><span class="bar-val" id="water-val">100</span></div>
    <div class="bar-row"><span class="bar-label">âœ¨ XP</span><div class="bar-bg"><div class="bar-fill" id="xp-fill" style="width:0%"></div></div><span class="bar-val" id="xp-val">0</span></div>
  </div>

  <div id="hotbar"></div>

  <div id="hud-btns">
    <button class="hud-btn" onclick="toggleInventory()">INV [E]</button>
    <button class="hud-btn" onclick="toggleCraft()">CRAFT [C]</button>
    <button class="hud-btn" onclick="toggleBuild()">BUILD [B]</button>
    <button class="hud-btn" onclick="tryInteractKey()">ENTRAR [F]</button>
    <button class="hud-btn" onclick="dropSelected()">DROPAR</button>
  </div>

  <div id="chat-box">
    <div id="chat-msgs"></div>
    <div id="chat-input-row">
      <input type="text" id="chat-input" placeholder="[T] falar..."/>
      <button id="chat-send" onclick="sendChat()">OK</button>
    </div>
  </div>

  <div id="leaderboard" class="rpg-panel">
    <h4>âš” TOP HERÃ“IS</h4>
    <div id="lb-list"></div>
  </div>

  <div id="minimap-wrap" class="rpg-panel">
    <h4>â–£ MAPA</h4>
    <canvas id="minimap" width="152" height="152"></canvas>
  </div>

  <div id="notifs"></div>

  <div id="build-panel" class="rpg-panel">
    <h4>â–£ CONSTRUÃ‡ÃƒO</h4>
    <div class="build-grid" id="build-grid"></div>
    <div style="text-align:center"><button class="close-btn" style="font-size:.32rem;padding:4px 8px;margin-top:6px" onclick="toggleBuild()">âœ–</button></div>
  </div>

  <div id="water-alert"><p>âš  DESIDRATANDO! VÃ Ã€ ÃGUA!</p></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• INVENTÃRIO â•â•â•â•â•â•â•â•â•â• -->
<div id="inventory-screen">
  <div class="inv-panel">
    <h2>â–£ INVENTÃRIO</h2>
    <div class="inv-tabs">
      <button class="inv-tab active" onclick="invTab('all',this)">TUDO</button>
      <button class="inv-tab" onclick="invTab('resources',this)">RECURSOS</button>
      <button class="inv-tab" onclick="invTab('tools',this)">FERRAMENTAS</button>
      <button class="inv-tab" onclick="invTab('weapons',this)">ARMAS</button>
      <button class="inv-tab" onclick="invTab('food',this)">COMIDA</button>
      <button class="inv-tab" onclick="invTab('blocks',this)">BLOCOS</button>
    </div>
    <div class="inv-grid" id="inv-grid"></div>
    <div style="text-align:center"><button class="close-btn" onclick="toggleInventory()">âœ– FECHAR [E]</button></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CRAFT â•â•â•â•â•â•â•â•â•â• -->
<div id="craft-screen">
  <div class="craft-panel">
    <h2>âš’ MESA DE CRAFT</h2>
    <input class="craft-search" type="text" id="craft-search" placeholder="Buscar receita..." oninput="filterCraft()"/>
    <div class="craft-cats" id="craft-cats"></div>
    <div class="craft-list" id="craft-list"></div>
    <div style="text-align:center"><button class="close-btn" onclick="toggleCraft()">âœ– FECHAR [C]</button></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BAÃš â•â•â•â•â•â•â•â•â•â• -->
<div class="chest-loot" id="chest-modal">
  <h4>â–£ BAÃš ENCONTRADO</h4>
  <div class="chest-grid" id="chest-grid"></div>
  <div style="text-align:center;margin-top:8px">
    <button class="close-btn" style="font-size:.35rem;padding:5px 12px;margin-top:4px" onclick="closeChest()">âœ– FECHAR</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MORTE â•â•â•â•â•â•â•â•â•â• -->
<div id="death-screen">
  <h2>â˜  VOCÃŠ MORREU â˜ </h2>
  <p id="death-msg">Morto por: ???</p>
  <button id="respawn-btn" onclick="requestRespawn()">â†º RENASCER</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CLASS POPUP â•â•â•â•â•â•â•â•â•â• -->
<div id="class-popup">
  <canvas id="cp-canvas" class="cp-canvas" width="80" height="100"></canvas>
  <div class="cp-title">â˜… EVOLUÃ‡ÃƒO! â˜…</div>
  <div class="cp-name" id="cp-name">Guerreiro</div>
  <div class="cp-desc" id="cp-desc">VocÃª ficou mais forte!</div>
</div>

<div id="tooltip"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
"use strict";
const var_border = '#4a2a6a';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DADOS BASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TILE = 48, CHUNK = 16, INV_SIZE = 36, MAX_STACK = 64;

// â”€â”€ Durabilidade mÃ¡xima por item â”€â”€
const ITEM_DURABILITY = {
  wooden_sword:60,wooden_pickaxe:60,wooden_axe:60,wooden_shovel:60,
  stone_sword:132,stone_pickaxe:132,stone_axe:132,
  iron_sword:251,iron_pickaxe:251,iron_axe:251,iron_shovel:251,
  iron_helmet:165,iron_chestplate:240,iron_leggings:225,iron_boots:195,
  gold_sword:33,
  diamond_sword:1562,diamond_pickaxe:1562,diamond_chestplate:528,diamond_helmet:363,
  netherite_sword:2031,netherite_pickaxe:2031,
  bow:385,fishing_rod:65,
};
function getMaxDur(id){return ITEM_DURABILITY[id]||0;}
function useDurability(slotIdx,amount=1){
  const slot=G.inv[slotIdx];
  if(!slot||!slot.dur)return;
  slot.dur-=amount;
  if(slot.dur<=0){
    G.inv[slotIdx]=null;
    showNotif('ğŸ’” '+( ITEMS_DB[slot.item_id]?.name||slot.item_id)+' quebrou!','dmg');
    // Remove do hotbar se estava lÃ¡
    G.hotbar=G.hotbar.map(h=>h===slot.item_id?null:h);
    updateHotbarUI();
  }
}
function getEquippedSlot(){
  const eq=G.hotbar[G.hotbarIdx];if(!eq)return -1;
  for(let s=0;s<INV_SIZE;s++){if(G.inv[s]&&G.inv[s].item_id===eq)return s;}
  return -1;
}

// â”€â”€ Classes de personagem â”€â”€
const CLASSES = [
  {id:0,name:'AldeÃ£o',    desc:'O inÃ­cio da jornada',  kills:0,   maxHp:80,  damage:3,  speed:2.8,defense:0,  color:'#a0a0a0',skin:{body:'#d4a878',hair:'#6b3a2a',shirt:'#8888aa',pants:'#557755',weapon:null}},
  {id:1,name:'Escudeiro', desc:'Aprendiz de guerreiro', kills:5,   maxHp:100, damage:5,  speed:3.0,defense:3,  color:'#6a9aff',skin:{body:'#d4a878',hair:'#3a3a8a',shirt:'#4466aa',pants:'#334488',weapon:'sword',armor:'#8899bb'}},
  {id:2,name:'Arqueiro',  desc:'Mestre das flechas',    kills:15,  maxHp:110, damage:8,  speed:3.5,defense:2,  color:'#6aff6a',skin:{body:'#c89060',hair:'#2a4a1a',shirt:'#448844',pants:'#2a5a2a',weapon:'bow',cloak:'#336633'}},
  {id:3,name:'Guerreiro', desc:'Lutador experiente',    kills:30,  maxHp:140, damage:13, speed:3.2,defense:7,  color:'#ffaa00',skin:{body:'#c88060',hair:'#222',shirt:'#886644',pants:'#664422',weapon:'sword',armor:'#aaaa88'}},
  {id:4,name:'Cavaleiro', desc:'Protetor das terras',   kills:55,  maxHp:170, damage:17, speed:2.9,defense:12, color:'#ff8800',skin:{body:'#c87858',hair:'#111',shirt:'#8899aa',pants:'#667788',weapon:'sword',armor:'#bbccdd',helm:true}},
  {id:5,name:'Paladino',  desc:'Luz nas trevas',        kills:90,  maxHp:200, damage:22, speed:3.0,defense:18, color:'#ffff88',skin:{body:'#f0c8a0',hair:'#f0e080',shirt:'#eeddaa',pants:'#ccbb88',weapon:'sword',armor:'#ddeeff',helm:true,glow:'#ffff44'}},
  {id:6,name:'Assassino', desc:'Sombra veloz e letal',  kills:140, maxHp:160, damage:30, speed:4.5,defense:10, color:'#aa00ff',skin:{body:'#886688',hair:'#111',shirt:'#220033',pants:'#110022',weapon:'dagger',cloak:'#330044',mask:true}},
  {id:7,name:'Feiticeiro',desc:'Mestre das arcanas',    kills:200, maxHp:180, damage:35, speed:3.3,defense:8,  color:'#00e5ff',skin:{body:'#a0c0d8',hair:'#88ccff',shirt:'#224488',pants:'#112266',weapon:'staff',glow:'#00aaff'}},
  {id:8,name:'Arquimago', desc:'Poder quase divino',    kills:280, maxHp:220, damage:45, speed:3.5,defense:15, color:'#ff44ff',skin:{body:'#c0a0e0',hair:'#ff88ff',shirt:'#440088',pants:'#220044',weapon:'staff',glow:'#ff00ff',crown:true}},
  {id:9,name:'LendÃ¡rio',  desc:'O MÃXIMO poder!',       kills:400, maxHp:300, damage:60, speed:4.0,defense:25, color:'#f0c040',skin:{body:'#ffe0a0',hair:'#f0c040',shirt:'#aa8800',pants:'#886600',weapon:'sword',armor:'#f0e060',helm:true,glow:'#ffcc00',wings:true}},
];

// â”€â”€ Mobs com nomes novos do Craft.io â”€â”€
const MOB_TYPES = {
  sombrio:    {name:'Sombrio',     xp:5,  damage:4,  speed:1.2,hp:20,loot:[{id:'bone',c:.6},{id:'iron_ingot',c:.3}]},
  ossalento:  {name:'Ossalento',   xp:5,  damage:5,  speed:1.5,hp:20,loot:[{id:'bone',c:.8},{id:'arrow',c:.5}]},
  teianhas:   {name:'Teianhas',    xp:4,  damage:3,  speed:2.5,hp:16,loot:[{id:'string',c:.7},{id:'silk',c:.3}]},
  estalador:  {name:'Estalador',   xp:7,  damage:25, speed:1.8,hp:20,loot:[{id:'gunpowder',c:.8}],explodes:true},
  voidwalker: {name:'VoidWalker',  xp:15, damage:10, speed:2.0,hp:40,loot:[{id:'void_shard',c:.5},{id:'diamond_ore',c:.3}]},
  gelado:     {name:'Gelado',      xp:6,  damage:7,  speed:1.6,hp:28,loot:[{id:'ice_crystal',c:.6}]},
  magmavil:   {name:'Magmavil',    xp:10, damage:12, speed:1.4,hp:35,loot:[{id:'blaze_rod',c:.5},{id:'coal_ore',c:.8}]},
  bruxalha:   {name:'Bruxalha',    xp:10, damage:6,  speed:1.5,hp:26,loot:[{id:'glowstone_dust',c:.5},{id:'redstone_ore',c:.4}]},
  dracozinho: {name:'Dracozinho',  xp:20, damage:18, speed:2.8,hp:60,loot:[{id:'dragon_scale',c:.7},{id:'gold_ore',c:.6}]},
  titanrock:  {name:'TitÃ£ de Pedra',xp:30,damage:22, speed:0.8,hp:100,loot:[{id:'granite',c:1},{id:'diamond_ore',c:.4},{id:'iron_ore',c:.9}]},
};

// â”€â”€ Biomas â”€â”€
const BIOMES = {
  PLAINS:   {name:'PlanÃ­cies',   cols:['#4a7a3a','#5a8a4a','#3a6a2a'],water:false},
  FOREST:   {name:'Floresta',    cols:['#1a4a1a','#2a5a2a','#1a3a1a'],water:false},
  DESERT:   {name:'Deserto',     cols:['#c8a050','#d4b060','#b89040'],water:false},
  SNOW:     {name:'Tundra',      cols:['#c8d8e8','#d8e8f8','#b8c8d8'],water:false},
  JUNGLE:   {name:'Selva',       cols:['#0a5a0a','#1a6a1a','#0a4a0a'],water:false},
  SAVANNA:  {name:'Savana',      cols:['#9a8040','#8a7030','#b09050'],water:false},
  TAIGA:    {name:'Taiga',       cols:['#2a4a2a','#3a5a3a','#2a3a2a'],water:false},
  MUSHROOM: {name:'Cogumelos',   cols:['#5a1a4a','#6a2a5a','#4a0a3a'],water:false},
  RIVER:    {name:'Rio',         cols:['#1a4a8a','#2a5a9a','#0a3a7a'],water:true},
  OCEAN:    {name:'Oceano',      cols:['#0a2a7a','#1a3a8a','#0a2060'],water:true},
  LAKE:     {name:'Lago',        cols:['#1a3a7a','#2a4a8a','#102860'],water:true},
  SWAMP:    {name:'PÃ¢ntano',     cols:['#2a3a1a','#3a4a2a','#1a2a10'],water:true},
};

// â”€â”€ Objetos do mundo â”€â”€
const WORLD_OBJS = {
  tree:       {icon:'ğŸŒ²',w:2,h:2,hp:5,loot:'oak_log',lmin:3,lmax:6,biomes:['PLAINS','FOREST','TAIGA'],ch:.06},
  birch:      {icon:'ğŸŒ³',w:2,h:2,hp:4,loot:'birch_log',lmin:3,lmax:5,biomes:['FOREST','PLAINS'],ch:.04},
  jungle_tree:{icon:'ğŸŒ´',w:2,h:3,hp:6,loot:'jungle_log',lmin:4,lmax:8,biomes:['JUNGLE'],ch:.1},
  acacia:     {icon:'ğŸŒµ',w:2,h:2,hp:4,loot:'acacia_log',lmin:2,lmax:5,biomes:['SAVANNA','DESERT'],ch:.05},
  stone:      {icon:'ğŸª¨',w:1,h:1,hp:8,loot:'cobblestone',lmin:2,lmax:5,biomes:['PLAINS','FOREST','SNOW','TAIGA'],ch:.04},
  iron:       {icon:'ğŸŸ«',w:1,h:1,hp:12,loot:'iron_ore',lmin:1,lmax:3,biomes:['PLAINS','FOREST','SNOW'],ch:.02},
  coal:       {icon:'â¬›',w:1,h:1,hp:8,loot:'coal_ore',lmin:2,lmax:4,biomes:['PLAINS','FOREST','TAIGA'],ch:.025},
  gold:       {icon:'ğŸŸ¡',w:1,h:1,hp:14,loot:'gold_ore',lmin:1,lmax:2,biomes:['DESERT','SAVANNA'],ch:.01},
  diamond:    {icon:'ğŸ’',w:1,h:1,hp:20,loot:'diamond_ore',lmin:1,lmax:2,biomes:['FOREST','TAIGA','SNOW'],ch:.005},
  emerald:    {icon:'ğŸ’š',w:1,h:1,hp:20,loot:'emerald_ore',lmin:1,lmax:2,biomes:['JUNGLE'],ch:.004},
  sand:       {icon:'ğŸ–',w:1,h:1,hp:2,loot:'sand',lmin:3,lmax:6,biomes:['DESERT'],ch:.1},
  bush:       {icon:'ğŸ«',w:1,h:1,hp:2,loot:'apple',lmin:1,lmax:2,biomes:['PLAINS','FOREST'],ch:.03},
  mushroom:   {icon:'ğŸ„',w:1,h:1,hp:1,loot:'red_mushroom',lmin:1,lmax:2,biomes:['MUSHROOM','FOREST'],ch:.05},
  wheat:      {icon:'ğŸŒ¾',w:1,h:1,hp:1,loot:'wheat',lmin:1,lmax:3,biomes:['PLAINS','SAVANNA'],ch:.04},
  reed:       {icon:'ğŸŒ¿',w:1,h:1,hp:2,loot:'sugar_cane',lmin:1,lmax:3,biomes:['RIVER','SWAMP'],ch:.08},
  lily:       {icon:'ğŸŒ¸',w:1,h:1,hp:1,loot:'flower',lmin:1,lmax:2,biomes:['PLAINS','LAKE'],ch:.05},
  sheep:      {icon:'ğŸ‘',w:1,h:1,hp:6,loot:'wool',lmin:1,lmax:3,biomes:['PLAINS','SAVANNA'],ch:.015},
  ice:        {icon:'ğŸ§Š',w:1,h:1,hp:4,loot:'ice_crystal',lmin:1,lmax:3,biomes:['SNOW'],ch:.04},
  coral:      {icon:'ğŸª¸',w:1,h:1,hp:3,loot:'coral',lmin:1,lmax:2,biomes:['OCEAN'],ch:.06},
  mushroom_big:{icon:'ğŸ„',w:2,h:2,hp:4,loot:'brown_mushroom',lmin:2,lmax:4,biomes:['MUSHROOM'],ch:.04},
};

// â”€â”€ Estruturas â”€â”€
const STRUCTURES = {
  cottage:  {name:'Casinha',    w:6,h:6, icon:'ğŸ ',biomes:['PLAINS','FOREST'],ch:.003,
    interior:{w:400,h:300,bg:'#2a1808',floor:'#5a3a18',
      furniture:[
        {type:'table',x:80,y:80,icon:'ğŸª‘'},{type:'table',x:160,y:80,icon:'ğŸ›'},
        {type:'chest',x:300,y:60,loot:[{id:'oak_log',n:5},{id:'apple',n:3},{id:'bread',n:2},{id:'coal_ore',n:4}]},
        {type:'chest',x:300,y:130,loot:[{id:'iron_ingot',n:2},{id:'stone',n:8},{id:'wooden_sword',n:1}]},
      ]
    }},
  house:    {name:'Casa',       w:8,h:8, icon:'ğŸ¡',biomes:['PLAINS','SAVANNA'],ch:.002,
    interior:{w:480,h:360,bg:'#1a1208',floor:'#6a4a20',
      furniture:[
        {type:'chest',x:60,y:60,loot:[{id:'bread',n:3},{id:'apple',n:2},{id:'iron_ingot',n:3},{id:'coal_ore',n:6}]},
        {type:'chest',x:60,y:160,loot:[{id:'iron_sword',n:1},{id:'iron_pickaxe',n:1},{id:'leather',n:4}]},
        {type:'chest',x:380,y:60,loot:[{id:'gold_ore',n:2},{id:'diamond_ore',n:1},{id:'emerald_ore',n:1}]},
      ]
    }},
  tower:    {name:'Torre',      w:5,h:8, icon:'ğŸ—¼',biomes:['PLAINS','DESERT','SNOW'],ch:.0015,
    interior:{w:320,h:480,bg:'#0a0808',floor:'#3a3030',
      furniture:[
        {type:'chest',x:240,y:80,loot:[{id:'iron_sword',n:1},{id:'iron_helmet',n:1},{id:'arrow',n:16},{id:'bow',n:1}]},
        {type:'chest',x:240,y:180,loot:[{id:'gold_ingot',n:4},{id:'diamond_ore',n:2},{id:'iron_chestplate',n:1}]},
        {type:'chest',x:60,y:360,loot:[{id:'netherite_scrap',n:1},{id:'blaze_rod',n:3},{id:'gunpowder',n:4}]},
      ]
    }},
  castle:   {name:'Castelo',   w:14,h:14,icon:'ğŸ°',biomes:['PLAINS','SNOW','DESERT'],ch:.0008,
    interior:{w:640,h:640,bg:'#080608',floor:'#282020',
      furniture:[
        {type:'chest',x:80,y:80,  loot:[{id:'diamond_sword',n:1},{id:'diamond_helmet',n:1},{id:'diamond_chestplate',n:1}]},
        {type:'chest',x:80,y:200, loot:[{id:'gold_ingot',n:8},{id:'diamond_ore',n:4},{id:'emerald_ore',n:3}]},
        {type:'chest',x:520,y:80, loot:[{id:'netherite_scrap',n:3},{id:'golden_apple',n:2},{id:'blaze_rod',n:6}]},
        {type:'chest',x:520,y:200,loot:[{id:'diamond_pickaxe',n:1},{id:'netherite_ingot',n:1},{id:'bow',n:1},{id:'arrow',n:32}]},
        {type:'chest',x:300,y:520,loot:[{id:'iron_ingot',n:16},{id:'gold_ingot',n:8},{id:'leather',n:10}]},
        {type:'chest',x:400,y:520,loot:[{id:'cooked_beef',n:8},{id:'bread',n:6},{id:'golden_apple',n:1}]},
      ]
    }},
  ruin:     {name:'RuÃ­nas',    w:6,h:6, icon:'ğŸš',biomes:['DESERT','SAVANNA','MUSHROOM'],ch:.002,
    interior:{w:380,h:380,bg:'#150e05',floor:'#3a2a10',
      furniture:[
        {type:'chest',x:280,y:60, loot:[{id:'iron_ore',n:4},{id:'bone',n:6},{id:'arrow',n:8}]},
        {type:'chest',x:280,y:160,loot:[{id:'gunpowder',n:3},{id:'redstone_ore',n:4},{id:'lapis_ore',n:3}]},
      ]
    }},
};

// â”€â”€ Items DB â”€â”€
const ITEMS_DB = {
  oak_log:{name:'Carvalho',icon:'ğŸªµ',cat:'resources'},birch_log:{name:'BÃ©tula',icon:'ğŸªµ',cat:'resources'},
  spruce_log:{name:'Abeto',icon:'ğŸªµ',cat:'resources'},jungle_log:{name:'Madeira Selva',icon:'ğŸªµ',cat:'resources'},
  acacia_log:{name:'AcÃ¡cia',icon:'ğŸªµ',cat:'resources'},dark_oak_log:{name:'Carvalho Escuro',icon:'ğŸªµ',cat:'resources'},
  stone:{name:'Pedra',icon:'ğŸª¨',cat:'resources'},cobblestone:{name:'Pedra Tosca',icon:'ğŸª¨',cat:'resources'},
  granite:{name:'Granito',icon:'ğŸª¨',cat:'resources'},coal_ore:{name:'CarvÃ£o',icon:'â¬›',cat:'resources'},
  iron_ore:{name:'MinÃ©rio Ferro',icon:'ğŸŸ«',cat:'resources'},gold_ore:{name:'MinÃ©rio Ouro',icon:'ğŸŸ¡',cat:'resources'},
  diamond_ore:{name:'Diamante',icon:'ğŸ’',cat:'resources'},emerald_ore:{name:'Esmeralda',icon:'ğŸ’š',cat:'resources'},
  lapis_ore:{name:'LÃ¡pis-LazÃºli',icon:'ğŸ”µ',cat:'resources'},redstone_ore:{name:'Redstone',icon:'ğŸ”´',cat:'resources'},
  netherite_scrap:{name:'Netherita Bruta',icon:'ğŸŸ£',cat:'resources'},
  iron_ingot:{name:'Lingote Ferro',icon:'â¬œ',cat:'resources'},gold_ingot:{name:'Lingote Ouro',icon:'ğŸŸ¨',cat:'resources'},
  netherite_ingot:{name:'Lingote Netherita',icon:'ğŸŸ¤',cat:'resources'},
  sand:{name:'Areia',icon:'ğŸ–',cat:'resources'},gravel:{name:'Cascalho',icon:'â¬›',cat:'resources'},
  clay:{name:'Argila',icon:'ğŸ§±',cat:'resources'},flint:{name:'SÃ­lex',icon:'â—‡',cat:'resources'},
  bone:{name:'Osso',icon:'ğŸ¦´',cat:'resources'},feather:{name:'Pena',icon:'ğŸª¶',cat:'resources'},
  leather:{name:'Couro',icon:'ğŸŸ«',cat:'resources'},string:{name:'Fio',icon:'ã€°',cat:'resources'},
  slimeball:{name:'Gosma',icon:'ğŸŸ¢',cat:'resources'},gunpowder:{name:'PÃ³lvora',icon:'ğŸ’¥',cat:'resources'},
  blaze_rod:{name:'BastÃ£o Blaze',icon:'ğŸ”¥',cat:'resources'},glowstone_dust:{name:'PÃ³ Brilhante',icon:'âœ¨',cat:'resources'},
  wheat:{name:'Trigo',icon:'ğŸŒ¾',cat:'resources'},sugar:{name:'AÃ§Ãºcar',icon:'ğŸ¤',cat:'resources'},
  wool:{name:'LÃ£',icon:'ğŸ‘',cat:'resources'},red_mushroom:{name:'Cogumelo Vermelho',icon:'ğŸ„',cat:'resources'},
  brown_mushroom:{name:'Cogumelo Marrom',icon:'ğŸ„',cat:'resources'},sugar_cane:{name:'Cana-de-aÃ§Ãºcar',icon:'ğŸŒ¿',cat:'resources'},
  silk:{name:'Seda',icon:'ğŸ•¸',cat:'resources'},void_shard:{name:'Fragmento do Vazio',icon:'ğŸŒ‘',cat:'resources'},
  ice_crystal:{name:'Cristal de Gelo',icon:'ğŸ§Š',cat:'resources'},dragon_scale:{name:'Escama de DragÃ£o',icon:'ğŸ‰',cat:'resources'},
  coral:{name:'Coral',icon:'ğŸª¸',cat:'resources'},flower:{name:'Flor',icon:'ğŸŒ¸',cat:'resources'},
  planks:{name:'TÃ¡buas',icon:'ğŸªµ',cat:'blocks'},crafting_table:{name:'Mesa de Craft',icon:'ğŸªš',cat:'blocks'},
  furnace:{name:'Fornalha',icon:'ğŸ”¥',cat:'blocks'},chest:{name:'BaÃº',icon:'ğŸ“¦',cat:'blocks'},
  torch:{name:'Tocha',icon:'ğŸ”¦',cat:'blocks'},stone_wall:{name:'Parede Pedra',icon:'ğŸ§±',cat:'blocks'},
  glass:{name:'Vidro',icon:'ğŸ”²',cat:'blocks'},door:{name:'Porta',icon:'ğŸšª',cat:'blocks'},
  bed:{name:'Cama',icon:'ğŸ›',cat:'blocks'},ladder:{name:'Escada',icon:'ğŸªœ',cat:'blocks'},
  stick:{name:'Graveto',icon:'ğŸ¥¢',cat:'resources'},bowl:{name:'Tigela',icon:'ğŸ¥£',cat:'resources'},
  apple:{name:'MaÃ§Ã£',icon:'ğŸ',cat:'food',hunger:4},bread:{name:'PÃ£o',icon:'ğŸ',cat:'food',hunger:6},
  cooked_beef:{name:'Bife Assado',icon:'ğŸ¥©',cat:'food',hunger:9},
  cooked_chicken:{name:'Frango Assado',icon:'ğŸ—',cat:'food',hunger:7},
  golden_apple:{name:'MaÃ§Ã£ Dourada',icon:'ğŸ',cat:'food',hunger:10,hp:20},
  mushroom_stew:{name:'Ensopado Cogumelo',icon:'ğŸ²',cat:'food',hunger:8},
  melon_slice:{name:'MelÃ£o',icon:'ğŸ‰',cat:'food',hunger:3},
  wooden_pickaxe:{name:'Picareta Madeira',icon:'â›',cat:'tools',damage:2,efficiency:1.2},
  wooden_axe:{name:'Machado Madeira',icon:'ğŸª“',cat:'tools',damage:3},
  wooden_sword:{name:'Espada Madeira',icon:'ğŸ—¡',cat:'weapons',damage:5},
  wooden_shovel:{name:'PÃ¡ Madeira',icon:'ğŸª£',cat:'tools'},wooden_hoe:{name:'Enxada',icon:'ğŸŒ±',cat:'tools'},
  stone_pickaxe:{name:'Picareta Pedra',icon:'â›',cat:'tools',damage:3,efficiency:2},
  stone_axe:{name:'Machado Pedra',icon:'ğŸª“',cat:'tools',damage:5},
  stone_sword:{name:'Espada Pedra',icon:'ğŸ—¡',cat:'weapons',damage:8},
  iron_pickaxe:{name:'Picareta Ferro',icon:'â›',cat:'tools',damage:4,efficiency:3},
  iron_axe:{name:'Machado Ferro',icon:'ğŸª“',cat:'tools',damage:7},
  iron_sword:{name:'Espada Ferro',icon:'âš”',cat:'weapons',damage:13},
  iron_helmet:{name:'Elmo Ferro',icon:'â›‘',cat:'tools',defense:5},
  iron_chestplate:{name:'Peitoral Ferro',icon:'ğŸ›¡',cat:'tools',defense:10},
  iron_leggings:{name:'CalÃ§as Ferro',icon:'ğŸ¦º',cat:'tools',defense:8},
  iron_boots:{name:'Botas Ferro',icon:'ğŸ‘¢',cat:'tools',defense:3},
  gold_sword:{name:'Espada Ouro',icon:'ğŸ—¡',cat:'weapons',damage:10},
  diamond_pickaxe:{name:'Picareta Diamante',icon:'â›',cat:'tools',damage:5,efficiency:5},
  diamond_sword:{name:'Espada Diamante',icon:'ğŸ’ ',cat:'weapons',damage:20},
  diamond_helmet:{name:'Elmo Diamante',icon:'â›‘',cat:'tools',defense:12},
  diamond_chestplate:{name:'Peitoral Diamante',icon:'ğŸ›¡',cat:'tools',defense:20},
  netherite_sword:{name:'Espada Netherita',icon:'âš¡',cat:'weapons',damage:35},
  netherite_pickaxe:{name:'Picareta Netherita',icon:'â›',cat:'tools',damage:6,efficiency:6},
  bow:{name:'Arco',icon:'ğŸ¹',cat:'weapons',damage:9,ranged:true},
  arrow:{name:'Flechas',icon:'â†‘',cat:'weapons'},
  shield:{name:'Escudo',icon:'ğŸ›¡',cat:'weapons',defense:15},
  bucket:{name:'Balde',icon:'ğŸª£',cat:'tools'},compass:{name:'BÃºssola',icon:'ğŸ§­',cat:'tools'},
  fishing_rod:{name:'Vara de Pescar',icon:'ğŸ£',cat:'tools'},book:{name:'Livro',icon:'ğŸ“–',cat:'tools'},
};

const RECIPES = {
  stick:{name:'Graveto x4',icon:'ğŸ¥¢',cat:'resources',req:{planks:2},gives:{stick:4}},
  planks:{name:'TÃ¡buas x4',icon:'ğŸªµ',cat:'blocks',req:{oak_log:1},gives:{planks:4}},
  crafting_table:{name:'Mesa de Craft',icon:'ğŸªš',cat:'blocks',req:{planks:4},gives:{crafting_table:1}},
  furnace:{name:'Fornalha',icon:'ğŸ”¥',cat:'blocks',req:{cobblestone:8},gives:{furnace:1}},
  chest:{name:'BaÃº',icon:'ğŸ“¦',cat:'blocks',req:{planks:8},gives:{chest:1}},
  torch:{name:'Tocha x4',icon:'ğŸ”¦',cat:'blocks',req:{coal_ore:1,oak_log:1},gives:{torch:4}},
  stone_wall:{name:'Parede Pedra x6',icon:'ğŸ§±',cat:'blocks',req:{cobblestone:6},gives:{stone_wall:6}},
  glass:{name:'Vidro x4',icon:'ğŸ”²',cat:'blocks',req:{sand:4},gives:{glass:4}},
  door:{name:'Porta x2',icon:'ğŸšª',cat:'blocks',req:{planks:6},gives:{door:2}},
  bed:{name:'Cama',icon:'ğŸ›',cat:'blocks',req:{planks:3,wool:3},gives:{bed:1}},
  ladder:{name:'Escada x4',icon:'ğŸªœ',cat:'blocks',req:{oak_log:7},gives:{ladder:4}},
  wooden_pickaxe:{name:'Picareta Madeira',icon:'â›',cat:'tools',req:{oak_log:3},gives:{wooden_pickaxe:1}},
  wooden_axe:{name:'Machado Madeira',icon:'ğŸª“',cat:'tools',req:{oak_log:3},gives:{wooden_axe:1}},
  wooden_sword:{name:'Espada Madeira',icon:'ğŸ—¡',cat:'weapons',req:{oak_log:2},gives:{wooden_sword:1}},
  wooden_shovel:{name:'PÃ¡ Madeira',icon:'ğŸª£',cat:'tools',req:{oak_log:2},gives:{wooden_shovel:1}},
  stone_pickaxe:{name:'Picareta Pedra',icon:'â›',cat:'tools',req:{cobblestone:3,oak_log:2},gives:{stone_pickaxe:1}},
  stone_axe:{name:'Machado Pedra',icon:'ğŸª“',cat:'tools',req:{cobblestone:3,oak_log:2},gives:{stone_axe:1}},
  stone_sword:{name:'Espada Pedra',icon:'ğŸ—¡',cat:'weapons',req:{cobblestone:2,oak_log:1},gives:{stone_sword:1}},
  iron_pickaxe:{name:'Picareta Ferro',icon:'â›',cat:'tools',req:{iron_ingot:3,oak_log:2},gives:{iron_pickaxe:1}},
  iron_axe:{name:'Machado Ferro',icon:'ğŸª“',cat:'tools',req:{iron_ingot:3,oak_log:2},gives:{iron_axe:1}},
  iron_sword:{name:'Espada Ferro',icon:'âš”',cat:'weapons',req:{iron_ingot:2,oak_log:1},gives:{iron_sword:1}},
  iron_helmet:{name:'Elmo Ferro',icon:'â›‘',cat:'tools',req:{iron_ingot:5},gives:{iron_helmet:1}},
  iron_chestplate:{name:'Peitoral Ferro',icon:'ğŸ›¡',cat:'tools',req:{iron_ingot:8},gives:{iron_chestplate:1}},
  iron_leggings:{name:'CalÃ§as Ferro',icon:'ğŸ¦º',cat:'tools',req:{iron_ingot:7},gives:{iron_leggings:1}},
  iron_boots:{name:'Botas Ferro',icon:'ğŸ‘¢',cat:'tools',req:{iron_ingot:4},gives:{iron_boots:1}},
  gold_sword:{name:'Espada Ouro',icon:'ğŸ—¡',cat:'weapons',req:{gold_ingot:2,oak_log:1},gives:{gold_sword:1}},
  diamond_pickaxe:{name:'Picareta Diamante',icon:'â›',cat:'tools',req:{diamond_ore:3,oak_log:2},gives:{diamond_pickaxe:1}},
  diamond_sword:{name:'Espada Diamante',icon:'ğŸ’ ',cat:'weapons',req:{diamond_ore:2,oak_log:1},gives:{diamond_sword:1}},
  diamond_helmet:{name:'Elmo Diamante',icon:'â›‘',cat:'tools',req:{diamond_ore:5},gives:{diamond_helmet:1}},
  diamond_chestplate:{name:'Peitoral Diamante',icon:'ğŸ›¡',cat:'tools',req:{diamond_ore:8},gives:{diamond_chestplate:1}},
  netherite_sword:{name:'Espada Netherita',icon:'âš¡',cat:'weapons',req:{diamond_sword:1,netherite_ingot:1},gives:{netherite_sword:1}},
  netherite_pickaxe:{name:'Picareta Netherita',icon:'â›',cat:'tools',req:{diamond_pickaxe:1,netherite_ingot:1},gives:{netherite_pickaxe:1}},
  bow:{name:'Arco',icon:'ğŸ¹',cat:'weapons',req:{oak_log:3,string:3},gives:{bow:1}},
  arrow:{name:'Flechas x16',icon:'â†‘',cat:'weapons',req:{flint:1,oak_log:1,feather:1},gives:{arrow:16}},
  shield:{name:'Escudo',icon:'ğŸ›¡',cat:'weapons',req:{planks:6,iron_ingot:1},gives:{shield:1}},
  bread:{name:'PÃ£o',icon:'ğŸ',cat:'food',req:{wheat:3},gives:{bread:1}},
  golden_apple:{name:'MaÃ§Ã£ Dourada',icon:'ğŸ',cat:'food',req:{apple:1,gold_ingot:8},gives:{golden_apple:1}},
  mushroom_stew:{name:'Ensopado Cogumelo',icon:'ğŸ²',cat:'food',req:{red_mushroom:1,brown_mushroom:1,bowl:1},gives:{mushroom_stew:1}},
  bucket:{name:'Balde',icon:'ğŸª£',cat:'tools',req:{iron_ingot:3},gives:{bucket:1}},
  compass:{name:'BÃºssola',icon:'ğŸ§­',cat:'tools',req:{iron_ingot:4,redstone_ore:1},gives:{compass:1}},
  fishing_rod:{name:'Vara de Pescar',icon:'ğŸ£',cat:'tools',req:{oak_log:3,string:2},gives:{fishing_rod:1}},
  bowl:{name:'Tigela x4',icon:'ğŸ¥£',cat:'resources',req:{planks:3},gives:{bowl:4}},
  book:{name:'Livro',icon:'ğŸ“–',cat:'tools',req:{leather:1,sugar:3,feather:1},gives:{book:1}},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERLIN NOISE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Perlin{
  constructor(s=42){this.p=[];const rng=this._lcg(s);for(let i=0;i<256;i++)this.p.push(i);for(let i=255;i>0;i--){const j=Math.floor(rng()*(i+1));[this.p[i],this.p[j]]=[this.p[j],this.p[i]];}this.p=[...this.p,...this.p];}
  _lcg(s){let n=s|0;return()=>{n=(n*1664525+1013904223)|0;return(n>>>0)/4294967296};}
  fade(t){return t*t*t*(t*(t*6-15)+10);}
  lerp(a,b,t){return a+t*(b-a);}
  grad(h,x,y){const u=h<2?x:y,v=h<2?y:x;return((h&1)?-u:u)+((h&2)?-v:v);}
  noise(x,y){const X=Math.floor(x)&255,Y=Math.floor(y)&255;x-=Math.floor(x);y-=Math.floor(y);const u=this.fade(x),v=this.fade(y);const a=this.p[X]+Y,b=this.p[X+1]+Y;return this.lerp(this.lerp(this.grad(this.p[a]&3,x,y),this.grad(this.p[b]&3,x-1,y),u),this.lerp(this.grad(this.p[a+1]&3,x,y-1),this.grad(this.p[b+1]&3,x-1,y-1),u),v);}
  oct(x,y,o=4,p=.5){let v=0,a=1,f=1,m=0;for(let i=0;i<o;i++){v+=this.noise(x*f,y*f)*a;m+=a;a*=p;f*=2;}return v/m;}
}
const P = new Perlin(42);
const P2 = new Perlin(137);
const P3 = new Perlin(251);

function getBiome(wx,wy){
  const s=.003;
  const t=P.oct(wx*s,wy*s);
  const m=P2.oct(wx*s,wy*s);
  const w=P3.oct(wx*s+50,wy*s+50);
  if(m>.35)return'OCEAN';
  if(w>.25&&m>.1)return'RIVER';
  if(w>.15&&m>-.05)return'LAKE';
  if(t>.45)return'SNOW';
  if(t>.22)return'TAIGA';
  if(t<-.45)return'DESERT';
  if(t<-.2)return'SAVANNA';
  if(w<-.2&&t>-.1)return'SWAMP';
  const j=P.oct(wx*s+200,wy*s+200);
  if(j>.32)return'JUNGLE';
  if(j<-.32)return'MUSHROOM';
  if(P.oct(wx*s+300,wy*s+300)>.18)return'FOREST';
  return'PLAINS';
}
function getTileColor(wx,wy){
  const b=getBiome(wx,wy);const info=BIOMES[b];
  const n=P.oct(wx*.06,wy*.06);
  return info.cols[Math.floor(((n+1)/2)*info.cols.length)%info.cols.length];
}
function isWaterTile(wx,wy){return BIOMES[getBiome(wx,wy)]?.water||false;}

function seededRNG(s){let n=(s^0x12345678)>>>0;return()=>{n=(n*1664525+1013904223)>>>0;return n/4294967296};}
const chunkCache={};
function getChunk(cx,cy){
  const key=`${cx},${cy}`;if(chunkCache[key])return chunkCache[key];
  const objs=[],structs=[],rng=seededRNG(cx*73856093^cy*19349663);
  for(let tx=0;tx<CHUNK;tx++)for(let ty=0;ty<CHUNK;ty++){
    const wx=cx*CHUNK+tx,wy=cy*CHUNK+ty;const biome=getBiome(wx,wy);
    // Estruturas
    for(const[id,def]of Object.entries(STRUCTURES)){
      if(!def.biomes.includes(biome))continue;
      if(rng()<def.ch){structs.push({id,def,wx,wy,entered:false});break;}
    }
    // Objetos
    for(const[id,def]of Object.entries(WORLD_OBJS)){
      if(!def.biomes.includes(biome))continue;
      if(rng()<def.ch){objs.push({id,def,wx,wy,hp:def.hp,maxHp:def.hp,dead:false});break;}
    }
  }
  return chunkCache[key]={objs,structs};
}
function getVisibleChunks(cx,cy,W,H){
  const x0=Math.floor((cx-W/2)/(CHUNK*TILE)),y0=Math.floor((cy-H/2)/(CHUNK*TILE));
  const x1=Math.ceil((cx+W/2)/(CHUNK*TILE)),y1=Math.ceil((cy+H/2)/(CHUNK*TILE));
  const r=[];for(let x=x0;x<=x1;x++)for(let y=y0;y<=y1;y++)r.push(getChunk(x,y));
  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESENHO DE PERSONAGENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawCharacter(ctx, x, y, classId, scale=1, facing=1, animTick=0) {
  const cls = CLASSES[classId] || CLASSES[0];
  const sk = cls.skin;
  const c = ctx;
  const bob = Math.sin(animTick * 0.2) * 2 * scale;
  const legSwing = Math.sin(animTick * 0.3) * 8 * scale;
  const armSwing = Math.sin(animTick * 0.3 + Math.PI) * 8 * scale;
  c.save();
  c.translate(x, y + bob);
  c.scale(facing, 1);

  // Glow especial
  if(sk.glow){
    c.shadowColor = sk.glow;
    c.shadowBlur = 16 * scale;
  }

  // ASAS (LendÃ¡rio)
  if(sk.wings){
    c.fillStyle='rgba(255,220,80,.3)';
    c.beginPath();
    c.ellipse(-28*scale,-10*scale,20*scale,12*scale,-.5,0,Math.PI*2);
    c.ellipse(28*scale,-10*scale,20*scale,12*scale,.5,0,Math.PI*2);
    c.fill();
    c.fillStyle='rgba(255,220,80,.6)';
    c.beginPath();
    c.ellipse(-22*scale,-8*scale,12*scale,7*scale,-.3,0,Math.PI*2);
    c.ellipse(22*scale,-8*scale,12*scale,7*scale,.3,0,Math.PI*2);
    c.fill();
  }

  // PERNAS
  const legW=6*scale, legH=14*scale;
  // Perna esquerda
  c.save();c.translate(-5*scale, 8*scale);c.rotate(legSwing*0.05);
  c.fillStyle=sk.pants;c.fillRect(-legW/2, 0, legW, legH);
  // Sapato
  c.fillStyle='#222';c.fillRect(-legW/2-1*scale, legH-3*scale, legW+2*scale, 4*scale);
  c.restore();
  // Perna direita
  c.save();c.translate(5*scale, 8*scale);c.rotate(-legSwing*0.05);
  c.fillStyle=sk.pants;c.fillRect(-legW/2, 0, legW, legH);
  c.fillStyle='#222';c.fillRect(-legW/2-1*scale, legH-3*scale, legW+2*scale, 4*scale);
  c.restore();

  // ARMADURA PERNAS
  if(sk.armor){
    c.fillStyle=sk.armor+'88';
    c.fillRect(-8*scale, 8*scale, 7*scale, 10*scale);
    c.fillRect(2*scale, 8*scale, 7*scale, 10*scale);
  }

  // CAPA
  if(sk.cloak){
    c.fillStyle=sk.cloak;
    c.beginPath();
    c.moveTo(-8*scale, -8*scale);
    c.lineTo(8*scale, -8*scale);
    c.lineTo(10*scale, 18*scale);
    c.lineTo(-10*scale, 18*scale);
    c.closePath();
    c.fill();
  }

  // CORPO (torso)
  const bW=14*scale, bH=14*scale;
  c.fillStyle=sk.shirt;
  c.fillRect(-bW/2, -bH, bW, bH);

  // ARMADURA PEITO
  if(sk.armor){
    c.fillStyle=sk.armor;
    c.fillRect(-bW/2, -bH, bW, bH);
    // Detalhes da armadura
    c.fillStyle='rgba(255,255,255,.15)';
    c.fillRect(-bW/2+2*scale, -bH+2*scale, bW-4*scale, 4*scale);
    c.fillRect(-bW/2, -bH/2, bW, 2*scale);
  }

  // BRAÃ‡O esquerdo
  const aW=5*scale, aH=13*scale;
  c.save();c.translate(-bW/2-aW/2, -bH+2*scale);c.rotate(armSwing*0.05);
  c.fillStyle=sk.shirt;c.fillRect(-aW/2, 0, aW, aH);
  if(sk.armor){c.fillStyle=sk.armor+'aa';c.fillRect(-aW/2, 0, aW, aH);}
  c.fillStyle=sk.body;c.fillRect(-aW/2, aH-5*scale, aW, 5*scale);
  c.restore();

  // BRAÃ‡O direito + ARMA
  c.save();c.translate(bW/2+aW/2, -bH+2*scale);
  const weaponRot = Math.sin(animTick*0.15)*0.1;
  c.rotate(-armSwing*0.05+weaponRot);
  c.fillStyle=sk.shirt;c.fillRect(-aW/2, 0, aW, aH);
  if(sk.armor){c.fillStyle=sk.armor+'aa';c.fillRect(-aW/2, 0, aW, aH);}
  c.fillStyle=sk.body;c.fillRect(-aW/2, aH-5*scale, aW, 5*scale);
  // Arma â€” detecta item equipado (se for o jogador local)
  const _equippedId = (G&&G.hotbar)?G.hotbar[G.hotbarIdx]:null;
  const _isDiamond = _equippedId&&_equippedId.startsWith('diamond');
  const _isNetherite = _equippedId&&_equippedId.startsWith('netherite');
  const _isGold = _equippedId&&_equippedId.startsWith('gold');
  const _isStone = _equippedId&&_equippedId.startsWith('stone');
  const _isIron = _equippedId&&_equippedId.startsWith('iron');
  if(sk.weapon==='sword'){
    // LÃ¢mina
    const bladeCol=_isDiamond?'#55eeff':_isNetherite?'#8855cc':_isGold?'#ffdd44':_isIron?'#bbccdd':_isStone?'#aaaaaa':'#ddbb88';
    const glowCol=_isDiamond?'#00ddff':_isNetherite?'#6600aa':null;
    if(glowCol){c.shadowColor=glowCol;c.shadowBlur=8*scale;}
    // Formato de espada: ponta triangular + lÃ¢mina larga
    c.fillStyle=bladeCol;
    // Ponta da espada (triÃ¢ngulo)
    c.beginPath();
    c.moveTo(3.5*scale,-10*scale);
    c.lineTo(1*scale,-2*scale);
    c.lineTo(6*scale,-2*scale);
    c.closePath();c.fill();
    // LÃ¢mina principal
    c.fillRect(1.5*scale,-2*scale,5*scale,12*scale);
    // Brilho da lÃ¢mina
    c.fillStyle='rgba(255,255,255,.35)';
    c.fillRect(2*scale,-2*scale,1.5*scale,10*scale);
    c.shadowBlur=0;
    // Guarda (crossguard)
    c.fillStyle=_isDiamond?'#0088aa':_isNetherite?'#4400aa':_isGold?'#cc8800':'#666';
    c.fillRect(-1*scale,10*scale,10*scale,3*scale);
    // Punho
    c.fillStyle='#5a3010';
    c.fillRect(2.5*scale,13*scale,3*scale,7*scale);
    // Pommel (base do punho)
    c.fillStyle=_isDiamond?'#0088aa':_isNetherite?'#4400aa':'#444';
    c.beginPath();c.arc(4*scale,21*scale,3*scale,0,Math.PI*2);c.fill();
  } else if(sk.weapon==='bow'){
    c.strokeStyle='#8B6914';c.lineWidth=2*scale;
    c.beginPath();c.arc(4*scale,8*scale,10*scale,.6,2.5);c.stroke();
    c.strokeStyle='#ddd';c.lineWidth=scale;
    c.beginPath();c.moveTo(4*scale,-2*scale);c.lineTo(4*scale,18*scale);c.stroke();
  } else if(sk.weapon==='staff'){
    c.fillStyle='#6B4A1A';c.fillRect(2*scale,-6*scale,3*scale,22*scale);
    c.fillStyle=sk.glow||'#88aaff';c.shadowColor=sk.glow||'#88aaff';c.shadowBlur=8*scale;
    c.beginPath();c.arc(3*scale,-8*scale,5*scale,0,Math.PI*2);c.fill();
    c.shadowBlur=0;
  } else if(sk.weapon==='dagger'){
    c.fillStyle='#aaaacc';c.fillRect(2*scale,0,2*scale,12*scale);
    c.fillStyle='#443322';c.fillRect(1*scale,12*scale,4*scale,4*scale);
  }
  c.restore();

  // PESCOÃ‡O
  c.fillStyle=sk.body;c.fillRect(-3*scale,-bH-4*scale,6*scale,5*scale);

  // CABEÃ‡A
  const hS=14*scale;
  c.fillStyle=sk.body;
  c.fillRect(-hS/2,-bH-4*scale-hS,hS,hS);

  // CAPACETE
  if(sk.helm){
    c.fillStyle=sk.armor||'#aaa';
    c.fillRect(-hS/2-1*scale,-bH-4*scale-hS-1*scale,hS+2*scale,hS*.6);
    c.fillStyle='rgba(0,0,0,.3)';c.fillRect(-2*scale,-bH-4*scale-hS/2,4*scale,3*scale);
  }

  // COROA (Arquimago/LendÃ¡rio)
  if(sk.crown){
    c.fillStyle=sk.glow||'#ffdd00';
    c.shadowColor=sk.glow||'#ffdd00';c.shadowBlur=10*scale;
    // pontas da coroa
    for(let i=0;i<3;i++){
      const cx2=(-hS/2+2*scale)+i*(hS/2.5);
      c.fillRect(cx2,-bH-4*scale-hS-5*scale,3*scale,5*scale);
    }
    c.fillRect(-hS/2,-bH-4*scale-hS-2*scale,hS,3*scale);
    c.shadowBlur=0;
  }

  // CABELO
  c.fillStyle=sk.hair;
  if(!sk.helm){
    c.fillRect(-hS/2,-bH-4*scale-hS,hS,5*scale);
    c.fillRect(-hS/2,-bH-4*scale-hS,3*scale,hS);
  }

  // MÃSCARA (Assassino)
  if(sk.mask){
    c.fillStyle='#110022';c.fillRect(-hS/2+2*scale,-bH-3*scale-hS,hS-4*scale,hS*.6);
    c.fillStyle='#ff00ff';c.shadowColor='#ff00ff';c.shadowBlur=6*scale;
    c.fillRect(-4*scale,-bH-2*scale-hS+3*scale,3*scale,2*scale);
    c.fillRect(2*scale,-bH-2*scale-hS+3*scale,3*scale,2*scale);
    c.shadowBlur=0;
  } else {
    // OLHOS normais
    c.fillStyle='#fff';
    c.fillRect(-5*scale,-bH-2*scale-hS+3*scale,3*scale,3*scale);
    c.fillRect(2*scale,-bH-2*scale-hS+3*scale,3*scale,3*scale);
    c.fillStyle='#333';
    c.fillRect(-4*scale,-bH-1*scale-hS+3*scale,2*scale,2*scale);
    c.fillRect(3*scale,-bH-1*scale-hS+3*scale,2*scale,2*scale);
  }

  c.shadowBlur=0;
  c.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO DO JOGO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = {
  ws:null, myId:null, connected:false,
  player:{id:null,name:'',x:0,y:0,hp:80,maxHp:80,hunger:100,water:100,xp:0,level:1,kills:0,deaths:0,class_id:0,speed:3},
  inv:Array(INV_SIZE).fill(null),
  hotbar:Array(10).fill(null),
  hotbarIdx:0,
  otherPlayers:new Map(),
  mobs:[], drops:[], particles:[], buildings:[],
  canvas:null,ctx:null,mmc:null,mmctx:null,W:0,H:0,
  camera:{x:0,y:0},
  keys:{},mouse:{x:0,y:0,down:false},
  tick:0,time:0,day:1,dayPhase:'day',
  dead:false,
  invOpen:false,craftOpen:false,buildOpen:false,
  invTab:'all',craftCat:'all',craftFilter:'',
  selectedBuild:null,
  attackCd:0,
  classes:CLASSES,
  // Interior
  insideBuilding:null,
  interiorCanvas:null,interiorCtx:null,
  chestOpen:null,
  // Ãgua
  onWater:false,
  waterAlertTimer:0,
  animTick:0,
  facing:1,
  moving:false,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTÃRIO CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function invAdd(itemId,count){
  const it=ITEMS_DB[itemId];
  // Ferramentas/armas/equipamentos: sempre slot Ãºnico (nÃ£o empilham)
  const noStack=['sword','pickaxe','axe','shovel','bow','shield','helmet','chestplate','leggings','boots','hoe','fishing_rod','compass','bucket'];
  const isEquip=noStack.some(k=>itemId.includes(k));
  if(isEquip){
    // Procura slot vazio
    for(let s=0;s<INV_SIZE;s++){
      if(!G.inv[s]){
        G.inv[s]={item_id:itemId,count:1,dur:getMaxDur(itemId),maxDur:getMaxDur(itemId)};
        updateHotbarUI();if(G.invOpen)refreshInvUI();return true;
      }
    }
    return false;
  }
  let rem=count;
  // Tenta empilhar em slots existentes atÃ© MAX_STACK
  for(let s=0;s<INV_SIZE&&rem>0;s++){
    if(G.inv[s]&&G.inv[s].item_id===itemId&&G.inv[s].count<MAX_STACK){
      const sp=MAX_STACK-G.inv[s].count;
      const add=Math.min(sp,rem);
      G.inv[s].count+=add;
      rem-=add;
    }
  }
  // Abre novos slots para o restante
  for(let s=0;s<INV_SIZE&&rem>0;s++){
    if(!G.inv[s]){
      const add=Math.min(MAX_STACK,rem);
      G.inv[s]={item_id:itemId,count:add};
      rem-=add;
    }
  }
  updateHotbarUI();if(G.invOpen)refreshInvUI();return rem===0;
}
function invRemove(itemId,count){
  let rem=count;
  for(let s=0;s<INV_SIZE&&rem>0;s++){if(G.inv[s]&&G.inv[s].item_id===itemId){const r=Math.min(G.inv[s].count,rem);G.inv[s].count-=r;rem-=r;if(G.inv[s].count===0)G.inv[s]=null;}}
}
function invCount(itemId){return G.inv.reduce((t,s)=>t+(s&&s.item_id===itemId?s.count:0),0);}
function syncInv(arr){
  // Mescla o inventÃ¡rio do servidor com o local
  // Regra: para cada slot, mantÃ©m o MAIOR valor (cliente pode ter +itens de baÃº/mob)
  const newInv=arr.map((s,i)=>{
    if(!s)return G.inv?.[i]||null;// se servidor tem null, mantÃ©m o que o cliente tem
    const existing=G.inv&&G.inv[i];
    // Mesmo item: mantÃ©m o count maior e preserva durabilidade
    if(existing&&existing.item_id===s.item_id){
      const count=Math.max(s.count,existing.count);
      const dur=existing.dur!=null?existing.dur:(getMaxDur(s.item_id)||undefined);
      const maxDur=existing.maxDur||(getMaxDur(s.item_id)||undefined);
      return {item_id:s.item_id,count,dur,maxDur};
    }
    // Item diferente: usa o do servidor, mas inicializa durabilidade
    if(existing&&existing.item_id&&existing.item_id!==s.item_id){
      // Servidor substituiu o slot â€” aceita a versÃ£o do servidor
      const maxD=getMaxDur(s.item_id);
      return {item_id:s.item_id,count:s.count,dur:maxD||undefined,maxDur:maxD||undefined};
    }
    // Slot novo do servidor
    const maxD=getMaxDur(s.item_id);
    return {item_id:s.item_id,count:s.count,dur:maxD||undefined,maxDur:maxD||undefined};
  });
  // Para slots que o servidor nÃ£o tem mas o cliente tem (itens locais de baÃº/mob)
  // preserva eles se o servidor mandou null
  for(let i=0;i<INV_SIZE;i++){
    if(!newInv[i]&&G.inv?.[i]){
      newInv[i]=G.inv[i];// preserva item local
    }
  }
  G.inv=newInv;
  updateHotbarUI();if(G.invOpen)refreshInvUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  const url=`${proto}://${location.host}`;
  console.log('[WS] Conectando em',url);
  try{G.ws=new WebSocket(url);}catch(e){console.error('[WS] Erro ao criar WebSocket:',e);return;}
  G.ws.onopen=()=>{
    G.connected=true;
    const badge=document.getElementById('online-badge');
    if(badge){badge.textContent='ğŸŸ¢ SERVIDOR ONLINE';badge.style.borderColor='#2a5a1a';badge.style.color='#4aaa2a';}
    console.log('[WS] Conectado!');
    // Se jÃ¡ entrou no jogo, reenvia join
    if(G.playerName&&document.getElementById('login-screen').style.display==='none'){
      wsSend({type:'join',name:G.playerName});
    }
  };
  G.ws.onclose=(ev)=>{
    G.connected=false;
    const badge=document.getElementById('online-badge');
    if(badge){badge.textContent='ğŸ”´ RECONECTANDO...';badge.style.borderColor='#7a1818';badge.style.color='#ff6666';}
    console.log('[WS] Desconectado. CÃ³digo:',ev.code,'RazÃ£o:',ev.reason);
    // ReconexÃ£o automÃ¡tica apÃ³s 3s
    setTimeout(()=>{if(!G.connected)connectWS();},3000);
  };
  G.ws.onerror=(e)=>{
    console.error('[WS] Erro de WebSocket:',e);
    const badge=document.getElementById('online-badge');
    if(badge){badge.textContent='ğŸ”´ ERRO DE CONEXÃƒO';badge.style.borderColor='#7a1818';}
  };
  G.ws.onmessage=e=>{let d;try{d=JSON.parse(e.data);}catch{return;}handleMsg(d);};
}
function wsSend(o){
  if(G.ws&&G.ws.readyState===WebSocket.OPEN){
    G.ws.send(JSON.stringify(o));
  }else{
    // Enfileira mensagens importantes para enviar ao reconectar
    if(o.type==='join'||o.type==='move')return;// move Ã© descartÃ¡vel
    G._pendingMsgs=G._pendingMsgs||[];
    if(G._pendingMsgs.length<20)G._pendingMsgs.push(o);
  }
}

function handleMsg(d){
  switch(d.type){
    case 'init':
      G.myId=d.id;Object.assign(G.player,d.player);
      G.player.water=100;
      G.classes=d.classes||CLASSES;
      syncInv(d.inv);G.hotbar=d.hotbar||Array(10).fill(null);
      updateHUD();updatePlayerPanel();drawAvatarCanvas();
      showNotif('âš” Entrou no mundo!','craft');
      // Drena fila de mensagens pendentes
      if(G._pendingMsgs&&G._pendingMsgs.length){
        G._pendingMsgs.forEach(m=>wsSend(m));
        G._pendingMsgs=[];
      }
      break;
    case 'players_init':d.players.forEach(p=>G.otherPlayers.set(p.id,p));break;
    case 'player_join':G.otherPlayers.set(d.player.id,d.player);break;
    case 'player_leave':
      G.otherPlayers.delete(d.id);
      // Re-renderiza leaderboard sem o jogador que saiu
      {const lb=document.getElementById('lb-list');if(lb&&lb.innerHTML){const h4=lb.previousElementSibling;if(h4){const cur=parseInt(h4.textContent.match(/\d+/)?.[0]||'1');h4.textContent=`âš” ONLINE (${Math.max(1,cur-1)})`;}}
      G.otherPlayers.forEach((op,id)=>{});// trigger re-render na prÃ³xima vez
      }
      break;
    case 'player_move':if(G.otherPlayers.has(d.id)){G.otherPlayers.get(d.id).x=d.x;G.otherPlayers.get(d.id).y=d.y;}break;
    case 'player_update':G.otherPlayers.set(d.player.id,d.player);break;
    case 'inv_update':syncInv(d.inv);if(d.notification)showNotif(d.notification);break;
    case 'craft_ok':
      syncInv(d.inv);
      G.player.xp=d.xp;
      // Inicializa durabilidade de itens craftados
      G.inv.forEach((slot,i)=>{
        if(slot&&!slot.dur){const md=getMaxDur(slot.item_id);if(md){G.inv[i].dur=md;G.inv[i].maxDur=md;}}
      });
      if(d.notification)showNotif(d.notification,'craft');refreshCraftUI();updateHUD();break;
    case 'take_damage':G.player.hp-=d.dmg;if(G.player.hp<0)G.player.hp=0;showNotif(`ğŸ’¢ -${d.dmg} HP por ${d.fromName}`,'dmg');spawnParticles(G.player.x,G.player.y,'#ff4444',6);updateHUD();break;
    case 'kill_confirm':
      {const prev2=G.player.class_id;
      G.player.kills=d.kills;G.player.xp=d.xp;G.player.class_id=d.class_id;G.player.maxHp=d.maxHp;G.player.hp=d.hp;
      if(d.notification)showNotif(d.notification,'kill');
      if(d.class_id!==prev2){
        showClassPopup(d.class_id);drawAvatarCanvas();
        const nc=CLASSES[d.class_id];
        if(nc)showNotif(`ğŸŒŸ Evoluiu para ${nc.name}!`,'lv');
      }
      updateHUD();updatePlayerPanel();}break;
    case 'you_died':G.dead=true;G.player.x=d.x;G.player.y=d.y;G.player.hp=d.hp;document.getElementById('death-msg').textContent='Morto por: '+d.killerName;document.getElementById('death-screen').classList.add('show');break;
    case 'stats_update':G.player.hp=d.hp;G.player.hunger=d.hunger;if(d.inv)syncInv(d.inv);updateHUD();break;
    case 'chat':addChat(d.name,d.msg,d.sys?'sys':d.pvp?'pvp':'normal');break;
    case 'leaderboard':renderLeaderboard(d.data);break;
    case 'online_count':document.getElementById('online-badge').textContent=`ğŸŸ¢ ${d.count} HERÃ“IS ONLINE`;break;
    case 'building_placed':G.buildings.push(d);break;
    case 'error':showNotif('âš  '+d.msg,'dmg');break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESENHO DO AVATAR (HUD / popup)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawAvatarCanvas(){
  const cv=document.getElementById('avatar-canvas');
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,38,38);
  ctx.fillStyle='#0a0516';ctx.fillRect(0,0,38,38);
  drawCharacter(ctx,19,36,G.player.class_id,.55,1,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  const p=G.player;
  document.getElementById('cx').textContent=Math.floor(p.x/TILE);
  document.getElementById('cy').textContent=Math.floor(p.y/TILE);
  const b=getBiome(Math.floor(p.x/TILE),Math.floor(p.y/TILE));
  document.getElementById('biome-tag').textContent=BIOMES[b]?.name||b;
  document.getElementById('day-num').textContent=G.day;
  document.getElementById('time-str').textContent=G.dayPhase==='day'?'â˜€':'ğŸŒ™';
  document.getElementById('hp-fill').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('hp-val').textContent=Math.ceil(p.hp);
  document.getElementById('hunger-fill').style.width=(p.hunger/100*100)+'%';
  document.getElementById('hunger-val').textContent=Math.ceil(p.hunger);
  document.getElementById('water-fill').style.width=(p.water/100*100)+'%';
  document.getElementById('water-val').textContent=Math.ceil(p.water);
  document.getElementById('xp-fill').style.width=Math.min(100,p.xp/100*100)+'%';
  document.getElementById('xp-val').textContent=p.xp;
  // Alerta de Ã¡gua
  const alert=document.getElementById('water-alert');
  if(p.water<20){alert.classList.add('show');G.waterAlertTimer++;}
  else{alert.classList.remove('show');G.waterAlertTimer=0;}
}

function updatePlayerPanel(){
  const p=G.player;
  const cls=CLASSES[p.class_id]||CLASSES[0];
  const next=CLASSES[p.class_id+1];
  document.getElementById('pp-name').textContent=cls.name;
  document.getElementById('pp-desc').textContent=cls.desc;
  document.getElementById('pp-kills').textContent=p.kills;
  document.getElementById('pp-deaths').textContent=p.deaths||0;
  if(next){
    document.getElementById('pp-next').textContent=next.kills+' kills';
    const pct=Math.min(100,((p.kills-cls.kills)/(next.kills-cls.kills)*100));
    document.getElementById('pp-bar-fill').style.width=pct+'%';
  } else {
    document.getElementById('pp-next').textContent='MÃXIMO!';
    document.getElementById('pp-bar-fill').style.width='100%';
  }
}

function showClassPopup(cid){
  const cls=CLASSES[cid];if(!cls)return;
  const cv=document.getElementById('cp-canvas');
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,80,100);
  ctx.fillStyle='#08040f';ctx.fillRect(0,0,80,100);
  drawCharacter(ctx,40,95,cid,1.1,1,0);
  document.getElementById('cp-name').textContent=cls.name;
  document.getElementById('cp-desc').textContent=cls.desc;
  const p=document.getElementById('class-popup');
  p.style.display='block';
  setTimeout(()=>p.style.display='none',4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICAÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNotif(msg,type=''){
  const c=document.getElementById('notifs');
  const d=document.createElement('div');
  d.className='notif'+(type?' '+type:'');
  d.textContent=msg;
  c.appendChild(d);
  setTimeout(()=>d.remove(),3300);
  while(c.children.length>7)c.removeChild(c.firstChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOTBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHotbarUI(){
  const hb=document.getElementById('hotbar');
  hb.innerHTML='';
  G.hotbar.forEach((id,i)=>{
    const d=document.createElement('div');
    d.className='slot'+(i===G.hotbarIdx?' active':'');
    d.innerHTML=`<span class="slot-num">${i===9?0:i+1}</span>`;
    if(id){
      const it=ITEMS_DB[id];
      const cnt=invCount(id);
      // Acha slot com durabilidade
      const slot=G.inv.find(s=>s&&s.item_id===id&&s.dur!=null);
      const durBar=slot&&slot.maxDur?`<div style="position:absolute;bottom:2px;left:2px;right:2px;height:3px;background:#330;border-radius:1px"><div style="height:3px;width:${Math.max(0,slot.dur/slot.maxDur*100)}%;background:${slot.dur/slot.maxDur>.5?'#4f4':'#f80'};border-radius:1px;transition:.3s"></div></div>`:'';
      d.innerHTML+=`<span class="item-icon">${it?.icon||'?'}</span><span class="item-count">${cnt>1?cnt:''}</span>${durBar}`;
    }
    d.onclick=()=>{G.hotbarIdx=i;updateHotbarUI();};
    d.addEventListener('mouseenter',e=>showTooltip(e,id));
    d.addEventListener('mouseleave',hideTooltip);
    hb.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTooltip(e,id){
  if(!id)return;const it=ITEMS_DB[id];if(!it)return;
  const t=document.getElementById('tooltip');
  let h=`<h5>${it.icon||''} ${it.name||id}</h5>`;
  if(it.damage)h+=`<div class="tstat">âš” Dano: ${it.damage}</div>`;
  if(it.defense)h+=`<div class="tstat">ğŸ›¡ Defesa: +${it.defense}</div>`;
  if(it.hunger)h+=`<div class="tstat">ğŸ– Fome: +${it.hunger}</div>`;
  if(it.hp)h+=`<div class="tstat">â¤ HP: +${it.hp}</div>`;
  if(it.efficiency)h+=`<div class="tstat">â› EficiÃªncia: Ã—${it.efficiency}</div>`;
  h+=`<div class="tstat">Qtd: ${invCount(id)}</div>`;
  if(RECIPES[id])h+=`<div class="tcr">âš’ CraftÃ¡vel</div>`;
  t.innerHTML=h;t.style.display='block';
  t.style.left=Math.min(e.clientX+14,window.innerWidth-225)+'px';
  t.style.top=Math.min(e.clientY-10,window.innerHeight-180)+'px';
}
function hideTooltip(){document.getElementById('tooltip').style.display='none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTÃRIO UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleInventory(){G.invOpen=!G.invOpen;document.getElementById('inventory-screen').classList.toggle('open',G.invOpen);if(G.invOpen)refreshInvUI();}
function invTab(tab,btn){G.invTab=tab;document.querySelectorAll('.inv-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');refreshInvUI();}
function refreshInvUI(){
  const grid=document.getElementById('inv-grid');grid.innerHTML='';
  for(let s=0;s<INV_SIZE;s++){
    const slot=G.inv[s];const d=document.createElement('div');
    if(!slot){d.className='inv-slot empty';grid.appendChild(d);continue;}
    const it=ITEMS_DB[slot.item_id];
    if(G.invTab!=='all'&&it?.cat!==G.invTab){d.className='inv-slot empty';grid.appendChild(d);continue;}
    d.className='inv-slot';
    const durPct=slot.dur!=null&&slot.maxDur?slot.dur/slot.maxDur:null;
    const durStr=durPct!=null?`<div style="position:absolute;bottom:1px;left:2px;right:2px;height:3px;background:#220;border-radius:1px"><div style="height:3px;width:${Math.max(0,durPct*100)}%;background:${durPct>.5?'#4f4':durPct>.2?'#f80':'#f44'};border-radius:1px"></div></div>`:'';
    d.innerHTML=`<span class="item-icon">${it?.icon||'ğŸ“¦'}</span><span class="item-count">${slot.count>1?slot.count:''}</span><span class="item-name">${it?.name||slot.item_id}</span>${durStr}`;
    d.onclick=()=>useItem(slot.item_id);
    d.addEventListener('mouseenter',e=>showTooltip(e,slot.item_id));
    d.addEventListener('mouseleave',hideTooltip);
    grid.appendChild(d);
  }
}
function useItem(itemId){
  const it=ITEMS_DB[itemId];if(!it)return;
  if(it.hunger){wsSend({type:'eat',itemId,hunger:it.hunger,hpGain:it.hp||0});return;}
  const idx=G.hotbar.indexOf(null);const i=idx>=0?idx:G.hotbarIdx;
  G.hotbar[i]=itemId;wsSend({type:'hotbar',hotbar:G.hotbar});updateHotbarUI();
  showNotif(`âœ‹ ${it.name} equipado`,'craft');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRAFT UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CRAFT_CATS=['all','tools','weapons','blocks','food','resources'];
function toggleCraft(){G.craftOpen=!G.craftOpen;document.getElementById('craft-screen').classList.toggle('open',G.craftOpen);if(G.craftOpen)refreshCraftUI();}
function filterCraft(){G.craftFilter=document.getElementById('craft-search').value.toLowerCase();refreshCraftUI();}
function refreshCraftUI(){
  const cc=document.getElementById('craft-cats');cc.innerHTML='';
  CRAFT_CATS.forEach(c=>{const b=document.createElement('button');b.className='craft-cat'+(G.craftCat===c?' active':'');b.textContent=c.toUpperCase();b.onclick=()=>{G.craftCat=c;refreshCraftUI();};cc.appendChild(b);});
  const cl=document.getElementById('craft-list');cl.innerHTML='';
  for(const[id,rec]of Object.entries(RECIPES)){
    if(G.craftCat!=='all'&&rec.cat!==G.craftCat)continue;
    if(G.craftFilter&&!rec.name.toLowerCase().includes(G.craftFilter))continue;
    const can=canCraftLocal(rec);
    const d=document.createElement('div');d.className='craft-item'+(can?' can':'');
    let reqs='';for(const[iid,n]of Object.entries(rec.req)){const cnt=invCount(iid);const it=ITEMS_DB[iid];reqs+=`<span class="${cnt>=n?'has':'lacks'}">${it?.icon||''} ${it?.name||iid}: ${cnt}/${n}</span><br>`;}
    d.innerHTML=`<div class="craft-icon">${rec.icon||'ğŸ“¦'}</div><div class="craft-info"><h4>${rec.name}</h4><div class="craft-reqs">${reqs}</div><button class="craft-do" ${can?'':'disabled'} onclick="craftItem('${id}')">âš’ CRAFTAR</button></div>`;
    cl.appendChild(d);
  }
}
function canCraftLocal(rec){for(const[id,n]of Object.entries(rec.req))if(invCount(id)<n)return false;return true;}
function craftItem(id){wsSend({type:'craft',recipeId:id});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BUILD_ITEMS=['planks','stone_wall','glass','torch','chest','door','crafting_table','furnace','ladder'];
function toggleBuild(){G.buildOpen=!G.buildOpen;document.getElementById('build-panel').classList.toggle('open',G.buildOpen);refreshBuildUI();}
function refreshBuildUI(){
  const bg=document.getElementById('build-grid');bg.innerHTML='';
  BUILD_ITEMS.forEach(id=>{
    const it=ITEMS_DB[id];const cnt=invCount(id);
    const d=document.createElement('div');d.className='build-slot'+(G.selectedBuild===id?' sel':'');
    d.innerHTML=`<span class="item-icon">${it?.icon||'?'}</span><span class="bcount">${cnt}</span>`;
    d.onclick=()=>{G.selectedBuild=G.selectedBuild===id?null:id;refreshBuildUI();};
    d.addEventListener('mouseenter',e=>showTooltip(e,id));d.addEventListener('mouseleave',hideTooltip);
    bg.appendChild(d);
  });
}
function dropSelected(){
  const cur=G.hotbar[G.hotbarIdx];
  if(cur&&invCount(cur)>0){invRemove(cur,1);G.drops.push({id:cur,x:G.player.x+(Math.random()-.5)*60,y:G.player.y+(Math.random()-.5)*60,life:400});showNotif(`Dropou: ${ITEMS_DB[cur]?.name||cur}`);updateHotbarUI();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERIOR DE ESTRUTURAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterBuilding(struct){
  if(!struct||!struct.def.interior)return;
  G.insideBuilding=struct;
  const def=struct.def.interior;
  const ic=document.getElementById('interior-canvas');
  ic.classList.add('open');
  ic.width=G.W;ic.height=G.H;
  G.interiorCanvas=ic;
  G.interiorCtx=ic.getContext('2d');
  // PosiÃ§Ã£o inicial do jogador no interior: centro da tela, ligeiramente abaixo
  G.interiorPX = G.W/2;
  G.interiorPY = Math.min(G.H - 100, G.H * 0.7);
  document.getElementById('exit-btn').classList.add('show');
  const lbl=document.getElementById('interior-label');
  lbl.textContent='ğŸ  INTERIOR: '+struct.def.name;
  lbl.classList.add('show');
  setTimeout(()=>lbl.classList.remove('show'),2500);
  addChat('','ğŸšª Entrou em '+struct.def.name,'loot');
  renderInterior();
}
function exitBuilding(){
  G.insideBuilding=null;
  document.getElementById('interior-canvas').classList.remove('open');
  document.getElementById('exit-btn').classList.remove('show');
  closeChest();
  addChat('','â¬† Saiu da estrutura','sys');
}
function renderInterior(){
  if(!G.insideBuilding||!G.interiorCtx)return;
  const ic=G.interiorCtx;
  const def=G.insideBuilding.def.interior;
  const W=G.W, H=G.H;
  const px=G.interiorPX||W/2, py=G.interiorPY||(H-160);

  // â”€â”€ Fundo escuro â”€â”€
  ic.fillStyle=def.bg||'#0a0616';
  ic.fillRect(0,0,W,H);

  // â”€â”€ Ãrea do interior ocupa 85% da tela â”€â”€
  const margin=40;
  const iw=W-margin*2, ih=H-margin*2;
  const ox=margin, oy=margin;

  // Piso
  ic.fillStyle=def.floor||'#5a3a18';
  ic.fillRect(ox,oy,iw,ih);

  // PadrÃ£o de tÃ¡buas no piso
  ic.strokeStyle='rgba(0,0,0,.18)';ic.lineWidth=1;
  for(let x=0;x<iw;x+=50){ic.beginPath();ic.moveTo(ox+x,oy);ic.lineTo(ox+x,oy+ih);ic.stroke();}
  for(let y=0;y<ih;y+=50){ic.beginPath();ic.moveTo(ox,oy+y);ic.lineTo(ox+iw,oy+y);ic.stroke();}

  // Paredes laterais (espessura)
  const wt=18; // wall thickness
  ic.fillStyle='rgba(0,0,0,.55)';
  ic.fillRect(ox,oy,iw,wt);           // topo
  ic.fillRect(ox,oy+ih-wt,iw,wt);    // baixo
  ic.fillRect(ox,oy,wt,ih);           // esq
  ic.fillRect(ox+iw-wt,oy,wt,ih);    // dir

  // Parede de fundo com textura de pedra
  ic.fillStyle='#3a2a18';
  ic.fillRect(ox+wt,oy+wt,iw-wt*2,ih*.18);
  ic.strokeStyle='rgba(0,0,0,.3)';ic.lineWidth=1;
  for(let bx=ox+wt;bx<ox+iw-wt;bx+=40){
    for(let by=oy+wt;by<oy+ih*.18;by+=20){
      ic.strokeRect(bx,by,40,20);
    }
  }

  // Tochas nas paredes
  const torchY=oy+wt+30;
  [ox+iw*.25, ox+iw*.5, ox+iw*.75].forEach(tx=>{
    ic.fillStyle='#8B5a20';ic.fillRect(tx-3,torchY-16,6,14);
    // Chama animada
    const flicker=Math.sin(G.animTick*.15+tx)*.3+.7;
    ic.fillStyle=`rgba(255,${Math.floor(150+flicker*80)},0,${flicker})`;
    ic.beginPath();ic.ellipse(tx,torchY-20,5,8,0,0,Math.PI*2);ic.fill();
    ic.fillStyle=`rgba(255,255,100,${flicker*.4})`;
    ic.beginPath();ic.ellipse(tx,torchY-20,3,5,0,0,Math.PI*2);ic.fill();
    // Luz ambiente
    const grd=ic.createRadialGradient(tx,torchY-20,0,tx,torchY-20,80);
    grd.addColorStop(0,`rgba(255,180,0,${flicker*.12})`);
    grd.addColorStop(1,'rgba(255,180,0,0)');
    ic.fillStyle=grd;ic.beginPath();ic.arc(tx,torchY-20,80,0,Math.PI*2);ic.fill();
  });

  // Porta (saÃ­da) no fundo centro-baixo
  ic.fillStyle='#3a1a08';
  ic.fillRect(W/2-28,oy+ih-wt-70,56,70);
  ic.fillStyle='#5a2a0a';
  ic.fillRect(W/2-24,oy+ih-wt-66,48,64);
  ic.fillStyle='#c08030';ic.beginPath();ic.arc(W/2+14,oy+ih-wt-30,4,0,Math.PI*2);ic.fill();
  ic.strokeStyle='#8B5a20';ic.lineWidth=2;ic.strokeRect(W/2-28,oy+ih-wt-70,56,70);
  ic.fillStyle='rgba(240,192,0,.6)';ic.font='bold 10px Cinzel,serif';ic.textAlign='center';ic.textBaseline='bottom';
  ic.fillText('[F] SAIR',W/2,oy+ih-wt-72);
  // Dica de pular sobre mÃ³veis
  ic.fillStyle='rgba(200,180,255,.5)';ic.font='10px Cinzel,serif';
  ic.fillText('[ESPAÃ‡O] Pular sobre mÃ³veis',W/2,oy+wt+10);

  // â”€â”€ MÃ“VEIS â”€â”€
  // Reseta hitboxes a cada frame
  G.interiorHitboxes = [];
  // Distribui mÃ³veis pela sala em posiÃ§Ãµes fixas e grandes
  const structs_furniture = [
    // Linha de fundo
    {type:'table_long', x:ox+iw*.12, y:oy+ih*.22, w:90, h:45, icon:'ğŸª‘'},
    {type:'bookshelf',  x:ox+iw*.35, y:oy+ih*.08, w:70, h:60, icon:'ğŸ“š'},
    {type:'fireplace',  x:ox+iw*.5,  y:oy+ih*.08, w:80, h:55, icon:'ğŸ”¥'},
    {type:'bookshelf',  x:ox+iw*.65, y:oy+ih*.08, w:70, h:60, icon:'ğŸ“š'},
    // Meio
    {type:'table_round', x:ox+iw*.3,  y:oy+ih*.45, w:70, h:60, icon:'ğŸ½'},
    {type:'chair',       x:ox+iw*.22, y:oy+ih*.48, w:40, h:40, icon:'ğŸª‘'},
    {type:'chair',       x:ox+iw*.42, y:oy+ih*.48, w:40, h:40, icon:'ğŸª‘'},
    {type:'barrel',      x:ox+iw*.72, y:oy+ih*.42, w:45, h:50, icon:'ğŸ›¢'},
    {type:'barrel',      x:ox+iw*.80, y:oy+ih*.42, w:45, h:50, icon:'ğŸ›¢'},
    // Cama
    {type:'bed',         x:ox+iw*.08, y:oy+ih*.52, w:80, h:60, icon:'ğŸ›'},
  ];

  structs_furniture.forEach(f=>{
    const {type,x,y,w,h,icon}=f;
    // Registra hitbox para todos os mÃ³veis
    // Cadeiras tÃªm hitbox menor (pode chegar perto mas nÃ£o passar por cima)
    if(type==='chair'){
      G.interiorHitboxes.push({x:x+8,y:y+8,w:w-16,h:h-12});
    } else {
      G.interiorHitboxes.push({x,y,w,h});
    }
    // Sombra
    ic.fillStyle='rgba(0,0,0,.2)';ic.fillRect(x+4,y+4,w,h);
    if(type==='fireplace'){
      ic.fillStyle='#4a3020';ic.fillRect(x,y,w,h);
      ic.fillStyle='#2a1808';ic.fillRect(x+8,y+8,w-16,h-16);
      const ff=Math.sin(G.animTick*.2)*.3+.7;
      ic.fillStyle=`rgba(255,${Math.floor(100+ff*80)},0,${ff})`;
      ic.beginPath();ic.ellipse(x+w/2,y+h*.7,20,25,0,0,Math.PI*2);ic.fill();
      ic.fillStyle=`rgba(255,200,0,${ff*.5})`;
      ic.beginPath();ic.ellipse(x+w/2,y+h*.65,10,15,0,0,Math.PI*2);ic.fill();
    } else if(type==='bookshelf'){
      ic.fillStyle='#5a3a18';ic.fillRect(x,y,w,h);
      // Livros coloridos
      const bookColors=['#aa2222','#2255aa','#228822','#aa8822','#882288','#aa6622'];
      let bx=x+4;
      for(let i=0;i<6;i++){ic.fillStyle=bookColors[i];ic.fillRect(bx,y+8,8,h-16);bx+=9+Math.random()*3;}
      ic.strokeStyle='rgba(0,0,0,.3)';ic.strokeRect(x,y,w,h);
    } else if(type==='bed'){
      ic.fillStyle='#8B5a20';ic.fillRect(x,y,w,h);
      ic.fillStyle='#f0e8d8';ic.fillRect(x+4,y+4,w-8,h*.55);
      ic.fillStyle='#cc8866';ic.fillRect(x+4,y+h*.55,w-8,h*.4);
      ic.fillStyle='#f0f0f0';ic.fillRect(x+6,y+6,h*.45,h*.4);
      ic.strokeStyle='#6B4A2A';ic.strokeRect(x,y,w,h);
    } else if(type==='table_round'){
      ic.fillStyle='#8B5a20';
      ic.beginPath();ic.ellipse(x+w/2,y+h/2,w/2,h/2,0,0,Math.PI*2);ic.fill();
      ic.strokeStyle='#6B4A2A';ic.lineWidth=2;ic.stroke();
      // Itens na mesa
      ic.font='18px serif';ic.textAlign='center';ic.textBaseline='middle';
      ic.fillText('ğŸ•¯',x+w*.35,y+h*.45);ic.fillText('ğŸ·',x+w*.65,y+h*.45);
    } else if(type==='barrel'){
      ic.fillStyle='#8B5a20';ic.beginPath();ic.ellipse(x+w/2,y+h/2,w/2,h/2,0,0,Math.PI*2);ic.fill();
      ic.strokeStyle='#5a3a10';ic.lineWidth=3;
      ic.beginPath();ic.ellipse(x+w/2,y+h*.35,w*.45,8,0,0,Math.PI*2);ic.stroke();
      ic.beginPath();ic.ellipse(x+w/2,y+h*.65,w*.45,8,0,0,Math.PI*2);ic.stroke();
    } else {
      // genÃ©rico
      ic.fillStyle='#6B4A2A';ic.fillRect(x,y,w,h);
      ic.font='26px serif';ic.textAlign='center';ic.textBaseline='middle';
      ic.fillText(icon,x+w/2,y+h/2);
      ic.strokeStyle='#4a2a10';ic.lineWidth=1.5;ic.strokeRect(x,y,w,h);
    }
  });

  // â”€â”€ BaÃºs do interior da estrutura â”€â”€
  def.furniture.forEach(f=>{
    if(f.type!=='chest')return;
    // DistribuiÃ§Ã£o proporcional Ã  tela
    const cx2=ox+wt+20 + (f.x/def.w)*(iw-wt*2-80);
    const cy2=oy+wt+80 + (f.y/def.h)*(ih*.6);
    // Registra hitbox do baÃº
    G.interiorHitboxes.push({x:cx2,y:cy2,w:56,h:44});
    // Sombra
    ic.fillStyle='rgba(0,0,0,.3)';ic.fillRect(cx2+5,cy2+5,56,44);
    // Corpo do baÃº
    ic.fillStyle='#5a3a10';ic.fillRect(cx2,cy2,56,44);
    ic.fillStyle='#8B5a20';ic.fillRect(cx2+2,cy2+2,52,18);
    // Fechadura
    ic.fillStyle='#f0c040';ic.fillRect(cx2+22,cy2+18,12,12);
    ic.fillStyle='#aa8820';ic.beginPath();ic.arc(cx2+28,cy2+22,4,0,Math.PI*2);ic.fill();
    ic.strokeStyle='#f0c040';ic.lineWidth=2;ic.strokeRect(cx2,cy2,56,44);
    // Ãcone
    ic.font='14px serif';ic.textAlign='center';ic.textBaseline='middle';
    ic.fillText('ğŸ“¦',cx2+28,cy2+34);
    // Hint de interaÃ§Ã£o
    const dist=Math.hypot((cx2+28)-px,(cy2+22)-py);
    if(dist<110){
      ic.fillStyle='rgba(240,192,0,.95)';ic.font='bold 12px Cinzel,serif';
      ic.textAlign='center';ic.textBaseline='bottom';
      ic.fillText('[F] ABRIR BAÃš',cx2+28,cy2-6);
      // Guarda coordenada para abertura
      f._screenX=cx2+28;f._screenY=cy2;
    } else {
      delete f._screenX;
    }
  });

  // â”€â”€ Jogador â”€â”€
  // Sombra
  ic.fillStyle='rgba(0,0,0,.22)';ic.beginPath();ic.ellipse(px,py+6,15,5,0,0,Math.PI*2);ic.fill();
  drawCharacter(ic,px,py,G.player.class_id,1,G.facing,G.moving?G.animTick:0);
  // HP bar
  const hbw=60;
  ic.fillStyle='#220008';ic.fillRect(px-hbw/2,py-54,hbw,6);
  ic.fillStyle=G.player.hp/G.player.maxHp>.5?'#22cc22':'#cc2222';
  ic.fillRect(px-hbw/2,py-54,hbw*(G.player.hp/G.player.maxHp),6);
  ic.fillStyle='rgba(240,192,0,.85)';ic.font='bold 10px Cinzel,serif';ic.textAlign='center';ic.textBaseline='bottom';
  ic.fillText(G.player.name,px,py-56);

  // Vinheta interior
  const vig2=ic.createRadialGradient(W/2,H/2,Math.min(W,H)*.35,W/2,H/2,Math.max(W,H)*.7);
  vig2.addColorStop(0,'rgba(0,0,0,0)');vig2.addColorStop(1,'rgba(0,0,0,.6)');
  ic.fillStyle=vig2;ic.fillRect(0,0,W,H);
}

function tryInteractKey(){
  if(G.insideBuilding){
    // 1Âº tenta abrir baÃº prÃ³ximo
    const def=G.insideBuilding.def.interior;
    let foundChest=false;
    for(const f of def.furniture){
      if(f.type==='chest'&&f._screenX!==undefined){
        openChest(f,f._screenX,f._screenY);
        foundChest=true;return;
      }
    }
    // 2Âº se nÃ£o hÃ¡ baÃº prÃ³ximo, sai da estrutura
    if(!foundChest){exitBuilding();return;}
  } else {
    // Procura estrutura prÃ³xima â€” usa centro da estrutura em pixels
    const p=G.player;
    const chunks=getVisibleChunks(G.camera.x,G.camera.y,G.W,G.H);
    for(const ch of chunks){
      for(const s of ch.structs){
        // Centro da estrutura em pixels
        const centerX = s.wx*TILE + (s.def.w*TILE)/2;
        const centerY = s.wy*TILE + (s.def.h*TILE)/2;
        const dist=Math.hypot(centerX-p.x,centerY-p.y);
        // Range = metade do tamanho da estrutura + 80px de margem
        const enterRange = (s.def.w*TILE)/2 + 80;
        if(dist<enterRange){enterBuilding(s);return;}
      }
    }
    showNotif('Nenhuma estrutura prÃ³xima. Chegue mais perto e pressione F.','dmg');
  }
}

function openChest(f,cx,cy){
  if(!f.loot||f.loot.length===0){showNotif('BaÃº vazio...','dmg');return;}
  // Acha o Ã­ndice deste baÃº entre os baÃºs da estrutura
  const def=G.insideBuilding?.def?.interior;
  const chests=(def?.furniture||[]).filter(x=>x.type==='chest');
  const chestId=chests.indexOf(f);
  G.chestOpen=f;
  const modal=document.getElementById('chest-modal');
  const grid=document.getElementById('chest-grid');
  grid.innerHTML='';
  f.loot.forEach((l,lootIdx)=>{
    const el=document.createElement('div');
    el.className='chest-slot';
    const it=ITEMS_DB[l.id];
    const empty=l.n<=0;
    el.style.opacity=empty?'.25':'1';
    el.innerHTML=`<span class="item-icon">${it?.icon||'ğŸ“¦'}</span><span class="item-count">${l.n>0?l.n:''}</span>`;
    if(!empty){
      el.onclick=()=>stealFromChest(chestId,lootIdx,el);
      el.title=(it?.name||l.id)+' x'+l.n;
    }
    grid.appendChild(el);
  });
  modal.style.display='block';
  modal.style.left=Math.min(cx,G.W-310)+'px';
  modal.style.top=Math.max(100,cy-140)+'px';
  addChat('','ğŸ’° Encontrou um baÃº!','loot');
}
function stealFromChest(chestId,lootIdx,el){
  const def=G.insideBuilding?.def?.interior;
  if(!def)return;
  const chests=def.furniture.filter(f=>f.type==='chest');
  const chest=chests[chestId];
  if(!chest||!chest.loot||!chest.loot[lootIdx])return;
  const loot=chest.loot[lootIdx];
  if(!loot||loot.n<=0)return;
  const itemId=loot.id;
  const amount=loot.n;
  // Marca como roubado ANTES de adicionar (evita duplo clique)
  loot.n=0;
  el.style.opacity='.25';el.style.cursor='default';el.onclick=null;
  // Adiciona no inventÃ¡rio LOCAL â€” nÃ£o depende do servidor
  const ok=invAdd(itemId,amount);
  const itemName=ITEMS_DB[itemId]?.name||itemId;
  showNotif(`ğŸ’° ${itemName} x${amount}`,'loot');
  addChat('',`ğŸ’° Pegou ${itemName} x${amount}!`,'loot');
  // ForÃ§a atualizaÃ§Ã£o visual do inventÃ¡rio
  updateHotbarUI();
  if(G.invOpen)refreshInvUI();
  if(!ok) showNotif('âš  InventÃ¡rio cheio!','dmg');
}
function closeChest(){document.getElementById('chest-modal').style.display='none';G.chestOpen=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendChat(){const inp=document.getElementById('chat-input');const msg=inp.value.trim();if(!msg)return;inp.value='';wsSend({type:'chat',msg});}
function addChat(name,msg,type='normal'){
  const c=document.getElementById('chat-msgs');
  const d=document.createElement('div');
  d.className='chat-msg'+(type==='sys'?' sys':type==='pvp'?' pvp':type==='loot'?' loot':'');
  d.innerHTML=type==='sys'||type==='loot'?msg:`<span class="cn">${name}:</span> ${msg}`;
  c.appendChild(d);c.scrollTop=c.scrollHeight;
  while(c.children.length>50)c.removeChild(c.firstChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLeaderboard(data){
  const lb=document.getElementById('lb-list');
  // Filtra apenas jogadores online (self + otherPlayers)
  const onlineIds=new Set([G.myId,...G.otherPlayers.keys()]);
  const online=data.filter(e=>onlineIds.has(e.id));
  // Garante que o prÃ³prio jogador apareÃ§a mesmo sem estar no data
  if(!online.find(e=>e.id===G.myId)&&G.player.name){
    online.push({...G.player,id:G.myId});
  }
  // Ordena por kills desc
  online.sort((a,b)=>(b.kills||0)-(a.kills||0));
  lb.innerHTML=online.slice(0,8).map((e,i)=>{
    const cls=CLASSES[e.class_id]||CLASSES[0];
    const me=e.id===G.myId;
    return `<div class="lb-row${me?' lb-me':''}">
      <span class="lb-rank">${i+1}</span>
      <span>${cls.icon}</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:'VT323',monospace;font-size:.9rem;letter-spacing:.5px">${e.name}</span>
      <span class="lb-score">${e.kills||0}âš”</span>
    </div>`;
  }).join('');
  // Atualiza contagem online
  const count=online.length;
  const h4=lb.previousElementSibling;
  if(h4)h4.textContent=`âš” ONLINE (${count})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requestRespawn(){
  G.dead=false;
  G.player.hp=G.player.maxHp;
  G.player.hunger=100;
  G.player.water=100;
  // Reseta aggro de todos os mobs
  G.mobs.forEach(m=>{m.aggroed=false;m.atkCd=60;});
  // Teleporta para longe dos mobs ao redor
  G.player.x=(Math.random()-.5)*3000;
  G.player.y=(Math.random()-.5)*3000;
  G.camera.x=G.player.x;G.camera.y=G.player.y;
  document.getElementById('death-screen').classList.remove('show');
  showNotif('â†º Renasceu!','craft');
  wsSend({type:'respawn',x:G.player.x,y:G.player.y});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnMobs(n=6){
  for(let i=0;i<n;i++){
    const keys=Object.keys(MOB_TYPES);
    const t=MOB_TYPES[keys[Math.floor(Math.random()*keys.length)]];
    const a=Math.random()*Math.PI*2,d=600+Math.random()*1200;
    G.mobs.push({...t,id:Date.now()+i,x:G.player.x+Math.cos(a)*d,y:G.player.y+Math.sin(a)*d,maxHp:t.hp,angle:0,atkCd:0,animTick:Math.random()*100});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryInteract(){
  if(G.attackCd>0||G.dead)return;
  if(G.insideBuilding)return;
  const p=G.player;const range=85;
  for(const mob of G.mobs){if(Math.hypot(mob.x-p.x,mob.y-p.y)<range){attackMob(mob);return;}}
  for(const[id,op]of G.otherPlayers){if(Math.hypot(op.x-p.x,op.y-p.y)<range){wsSend({type:'attack',targetId:id});G.attackCd=20;return;}}
  const chunks=getVisibleChunks(G.camera.x,G.camera.y,G.W,G.H);
  let best=null,bestD=range;
  for(const ch of chunks)for(const obj of ch.objs){if(obj.dead)continue;const dd=Math.hypot(obj.wx*TILE-p.x,obj.wy*TILE-p.y);if(dd<bestD){bestD=dd;best=obj;}}
  if(best)harvestObj(best);
}
function getEquipEff(){const eq=G.hotbar[G.hotbarIdx];return ITEMS_DB[eq]?.efficiency||1;}
function getEquipDmg(){const eq=G.hotbar[G.hotbarIdx];return ITEMS_DB[eq]?.damage||1;}
function harvestObj(obj){
  const eff=getEquipEff();obj.hp-=eff;G.attackCd=12;
  spawnParticles(obj.wx*TILE,obj.wy*TILE,'#f0a020',4);
  // Gasta durabilidade da ferramenta equipada
  const es=getEquippedSlot();if(es>=0)useDurability(es,1);
  if(obj.hp<=0){
    obj.dead=true;
    const cnt=obj.def.lmin+Math.floor(Math.random()*(obj.def.lmax-obj.def.lmin+1));
    wsSend({type:'harvest',objKey:`${obj.wx},${obj.wy}`,loot:obj.def.loot,lootCount:cnt});
    spawnParticles(obj.wx*TILE,obj.wy*TILE,'#88ff44',8);
    setTimeout(()=>{obj.hp=obj.maxHp;obj.dead=false;},30000+Math.random()*60000);
  }
}
function attackMob(mob){
  const dmg=getEquipDmg();mob.hp-=dmg;G.attackCd=18;
  spawnParticles(mob.x,mob.y,'#ff4444',6);
  // Gasta durabilidade da arma
  const es=getEquippedSlot();if(es>=0)useDurability(es,2);
  if(mob.hp<=0){
    G.mobs.splice(G.mobs.indexOf(mob),1);
    showNotif(`ğŸ’€ Derrotou ${mob.name}!`,'kill');
    spawnParticles(mob.x,mob.y,'#ff8800',12);
    // Loot do mob vai para o inventÃ¡rio local
    const lootGained=[];
    for(const l of(mob.loot||[])){
      if(Math.random()<l.c){
        invAdd(l.id,1);
        lootGained.push(l.id);
      }
    }
    // Notifica o servidor: kill de mob â†’ servidor processa kills/XP/level
    wsSend({
      type:'kill_mob',
      mobName:mob.name,
      mobXp:mob.xp||5,
      loot:lootGained
    });
    updateHotbarUI();if(G.invOpen)refreshInvUI();
    setTimeout(()=>spawnMobs(1),12000);
  }
}
function placeBlock(wx,wy){
  if(!G.selectedBuild||invCount(G.selectedBuild)<1){showNotif('Sem item!','dmg');return;}
  wsSend({type:'build',itemId:G.selectedBuild,wx,wy});
  spawnParticles(wx*TILE,wy*TILE,'#c0c0c0',6);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTÃCULAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(x,y,color,n=8){
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=1+Math.random()*4;G.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,color,life:30+Math.random()*20,maxLife:50,size:3+Math.random()*4});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(){
  if(G.dead)return;
  G.tick++;G.animTick++;
  const p=G.player;

  if(G.insideBuilding){
    let dx=0,dy=0;
    if(G.keys['w']||G.keys['W']||G.keys['ArrowUp'])dy-=1;
    if(G.keys['s']||G.keys['S']||G.keys['ArrowDown'])dy+=1;
    if(G.keys['a']||G.keys['A']||G.keys['ArrowLeft']){dx-=1;G.facing=-1;}
    if(G.keys['d']||G.keys['D']||G.keys['ArrowRight']){dx+=1;G.facing=1;}
    const jumping=G.keys[' '];// espaÃ§o = pular sobre obstÃ¡culo
    G.moving=!!(dx||dy);
    if(dx||dy){
      const spd=3.5;
      const mag=Math.hypot(dx,dy);
      const nx=G.interiorPX+dx/mag*spd;
      const ny=G.interiorPY+dy/mag*spd;
      // Paredes externas (margem = 58px topo, 70px baixo, 58px lados)
      const minX=58,maxX=G.W-58,minY=90,maxY=G.H-70;
      const cx=Math.max(minX,Math.min(maxX,nx));
      const cy=Math.max(minY,Math.min(maxY,ny));
      // ColisÃ£o com hitboxes dos mÃ³veis (sÃ³ bloqueia se NÃƒO estiver pulando)
      let blocked=false;
      if(!jumping){
        for(const hb of (G.interiorHitboxes||[])){
          if(cx>hb.x-14&&cx<hb.x+hb.w+14&&cy>hb.y-14&&cy<hb.y+hb.h+14){
            blocked=true;break;
          }
        }
      }
      if(!blocked){G.interiorPX=cx;G.interiorPY=cy;}
    }
    renderInterior();
    return;
  }

  let dx=0,dy=0;
  if(G.keys['w']||G.keys['W']||G.keys['ArrowUp'])dy-=1;
  if(G.keys['s']||G.keys['S']||G.keys['ArrowDown'])dy+=1;
  if(G.keys['a']||G.keys['A']||G.keys['ArrowLeft']){dx-=1;G.facing=-1;}
  if(G.keys['d']||G.keys['D']||G.keys['ArrowRight']){dx+=1;G.facing=1;}
  G.moving=!!(dx||dy);
  if(dx||dy){const d=Math.hypot(dx,dy);p.x+=dx/d*p.speed;p.y+=dy/d*p.speed;}
  if(G.tick%3===0&&G.connected)wsSend({type:'move',x:p.x,y:p.y});
  if(G.mouse.down&&!G.invOpen&&!G.craftOpen)tryInteract();
  if(G.attackCd>0)G.attackCd--;
  G.camera.x+=(p.x-G.camera.x)*.1;G.camera.y+=(p.y-G.camera.y)*.1;

  // â”€â”€ ÃGUA â”€â”€
  const wx=Math.floor(p.x/TILE),wy=Math.floor(p.y/TILE);
  G.onWater=isWaterTile(wx,wy);
  // Hidrata em cima de Ã¡gua
  if(G.onWater&&p.water<100){
    p.water=Math.min(100,p.water+0.3);
    if(G.tick%80===0)showNotif('ğŸ’§ Bebendo Ã¡gua...','water');
  }
  // Sede cai devagar: 1 ponto a cada ~30s (600 ticks)
  if(G.tick%600===0&&!G.onWater){p.water=Math.max(0,p.water-1);}
  // Dano sÃ³ quando totalmente sem Ã¡gua
  if(p.water<=0&&G.tick%120===0){p.hp-=2;if(G.tick%240===0)showNotif('âš  Morrendo de sede!','dmg');spawnParticles(p.x,p.y,'#2288dd',4);}

  // â”€â”€ FOME â”€â”€
  if(G.tick%300===0){p.hunger=Math.max(0,p.hunger-1);if(p.hunger===0)p.hp=Math.max(0,p.hp-2);}
  if(p.hp<=0){G.dead=true;document.getElementById('death-msg').textContent='Morto por: Sede/Fome';document.getElementById('death-screen').classList.add('show');}

  // Ciclo dia/noite
  G.time+=.0005;const dt=G.time%1;const wd=G.dayPhase==='day';
  G.dayPhase=dt<.6?'day':'night';
  if(wd&&G.dayPhase==='night'){G.day++;spawnMobs(3);addChat('','ğŸŒ™ A noite chegou â€” monstros despertaram!','sys');}
  if(!wd&&G.dayPhase==='day'){addChat('','â˜€ Amanheceu â€” outro dia de sobrevivÃªncia!','sys');}

  // Mobs
  G.mobs.forEach(mob=>{
    mob.animTick=(mob.animTick||0)+1;
    const ddx=p.x-mob.x,ddy=p.y-mob.y,dist=Math.hypot(ddx,ddy);
    const aggroRange = G.dayPhase==='night'?400:260;  // range para INICIAR perseguiÃ§Ã£o
    const deaggroRange = G.dayPhase==='night'?600:400;// range para PARAR perseguiÃ§Ã£o
    // Sistema de aggro: uma vez aggroed, persegue atÃ© deaggro range
    if(dist<aggroRange) mob.aggroed=true;
    if(dist>deaggroRange) mob.aggroed=false;
    // Dentro de casa: mobs nÃ£o perseguem
    if(G.insideBuilding) mob.aggroed=false;
    if(mob.aggroed && dist>2){
      mob.x+=ddx/dist*mob.speed;
      mob.y+=ddy/dist*mob.speed;
    } else {
      // Wandering aleatÃ³rio lento
      if(Math.random()<0.02) mob.angle=(mob.angle||0)+(Math.random()-.5)*1.5;
      mob.x+=Math.cos(mob.angle||0)*0.5;
      mob.y+=Math.sin(mob.angle||0)*0.5;
    }
    if(mob.atkCd>0) mob.atkCd--;
    if(dist<50&&mob.atkCd<=0&&!G.insideBuilding&&!G.dead){
      mob.atkCd=70;
      const cls=CLASSES[p.class_id]||CLASSES[0];
      const dmg=Math.max(1,mob.damage-(cls.defense||0));
      p.hp-=dmg;
      showNotif(`ğŸ’¢ -${dmg} HP â€” ${mob.name}`,'dmg');
      spawnParticles(p.x,p.y,'#ff2200',5);
      if(p.hp<=0){
        G.dead=true;
        document.getElementById('death-msg').textContent='Morto por: '+mob.name;
        document.getElementById('death-screen').classList.add('show');
      }
      updateHUD();
    }
  });

  G.drops=G.drops.filter(d=>{d.life--;if(Math.hypot(d.x-p.x,d.y-p.y)<55){invAdd(d.id,1);updateHotbarUI();return false;}return d.life>0;});
  if(G.drops.length>100)G.drops=G.drops.slice(-100);
  G.particles=G.particles.filter(pt=>{pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=.1;pt.life--;pt.vx*=.95;return pt.life>0;});
  if(G.particles.length>200)G.particles=G.particles.slice(-200);// cap para evitar leak

  updateHUD();
  if(G.tick%100===0)wsSend({type:'ping',t:Date.now()});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MUNDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  if(G.insideBuilding)return;
  const c=G.ctx,W=G.W,H=G.H,cam=G.camera;
  c.clearRect(0,0,W,H);

  // Fundo escuro pixel art
  c.fillStyle=G.dayPhase==='day'?'#0a1408':'#04080a';
  c.fillRect(0,0,W,H);

  // â”€â”€ Tiles Pixel Art â”€â”€
  const ts=Math.floor((cam.x-W/2)/TILE),te=Math.floor((cam.y-H/2)/TILE);
  const te2=Math.ceil((cam.x+W/2)/TILE),te3=Math.ceil((cam.y+H/2)/TILE);
  for(let ty=te;ty<=te3;ty++)for(let tx=ts;tx<=te2;tx++){
    const sx=tx*TILE-cam.x+W/2,sy=ty*TILE-cam.y+H/2;
    renderPixelTile(c,sx,sy,tx,ty,TILE);
  }

  // â”€â”€ Blocos construÃ­dos â”€â”€
  for(const b of G.buildings){
    const sx=b.wx*TILE-cam.x+W/2,sy=b.wy*TILE-cam.y+H/2;
    if(sx<-TILE||sx>W+TILE||sy<-TILE||sy>H+TILE)continue;
    c.fillStyle='#2a1840';c.fillRect(sx,sy,TILE,TILE);
    c.strokeStyle='#4a2a6a';c.strokeRect(sx,sy,TILE,TILE);
    c.font=`${TILE*.6}px serif`;c.textAlign='center';c.textBaseline='middle';
    c.fillText(ITEMS_DB[b.itemId]?.icon||'?',sx+TILE/2,sy+TILE/2);
  }

  // â”€â”€ Chunks: objetos e estruturas â”€â”€
  const chunks=getVisibleChunks(cam.x,cam.y,W,H);

  // Estruturas primeiro (atrÃ¡s)
  for(const ch of chunks)for(const st of ch.structs){
    const sx=st.wx*TILE-cam.x+W/2,sy=st.wy*TILE-cam.y+H/2;
    const sw=st.def.w*TILE,sh=st.def.h*TILE;
    if(sx<-sw||sx>W+sw||sy<-sh||sy>H+sh)continue;
    renderStructure(c,sx,sy,st);
  }

  // Objetos
  for(const ch of chunks)for(const obj of ch.objs){
    if(obj.dead)continue;
    const sx=obj.wx*TILE-cam.x+W/2,sy=obj.wy*TILE-cam.y+H/2;
    if(sx<-TILE*3||sx>W+TILE*3||sy<-TILE*3||sy>H+TILE*3)continue;
    c.fillStyle='rgba(0,0,0,.2)';c.beginPath();c.ellipse(sx+TILE/2,sy+TILE*obj.def.h*.9,TILE*.38,TILE*.12,0,0,Math.PI*2);c.fill();
    const fs=TILE*Math.max(obj.def.w,obj.def.h)*.72;c.font=`${fs}px serif`;c.textAlign='center';c.textBaseline='middle';
    c.fillText(obj.def.icon,sx+TILE*obj.def.w/2,sy+TILE*obj.def.h/2);
    if(obj.hp<obj.maxHp){const bw=TILE*obj.def.w;c.fillStyle='#220011';c.fillRect(sx,sy-8,bw,5);c.fillStyle='#33cc33';c.fillRect(sx,sy-8,bw*(obj.hp/obj.maxHp),5);}
  }

  // Drops
  for(const d of G.drops){
    const sx=d.x-cam.x+W/2,sy=d.y-cam.y+H/2;
    const bob=Math.sin(G.tick*.12)*3;
    c.font=`${TILE*.48}px serif`;c.textAlign='center';c.textBaseline='middle';
    c.fillText(ITEMS_DB[d.id]?.icon||'ğŸ“¦',sx,sy+bob);
    // Glow
    c.fillStyle='rgba(240,192,0,.15)';c.beginPath();c.arc(sx,sy+bob,16,0,Math.PI*2);c.fill();
  }

  // PartÃ­culas
  for(const pt of G.particles){
    const sx=pt.x-cam.x+W/2,sy=pt.y-cam.y+H/2;
    c.globalAlpha=pt.life/pt.maxLife;c.fillStyle=pt.color;
    c.beginPath();c.arc(sx,sy,pt.size,0,Math.PI*2);c.fill();
  }
  c.globalAlpha=1;

  // Outros jogadores
  for(const[id,op]of G.otherPlayers){
    const sx=op.x-cam.x+W/2,sy=op.y-cam.y+H/2;
    if(sx<-80||sx>W+80||sy<-80||sy>H+80)continue;
    drawCharacter(c,sx,sy,op.class_id||0,.85,1,G.tick*.5);
    // HP bar
    const bw=36;c.fillStyle='#220011';c.fillRect(sx-bw/2,sy-44,bw,5);
    const hpc=(op.hp||100)/(op.maxHp||100);c.fillStyle=hpc>.5?'#33cc33':hpc>.25?'#ccaa00':'#cc2222';c.fillRect(sx-bw/2,sy-44,bw*Math.max(0,hpc),5);
    c.font='bold 10px Cinzel,serif';c.fillStyle='#f0d060';c.textAlign='center';c.textBaseline='bottom';c.fillText(op.name,sx,sy-46);
    const cls=CLASSES[op.class_id||0];
    if(cls){c.font='9px serif';c.fillStyle=cls.color;c.fillText(cls.icon+' '+cls.name,sx,sy+30);}
  }

  // Mobs
  for(const mob of G.mobs){
    const sx=mob.x-cam.x+W/2,sy=mob.y-cam.y+H/2;
    if(sx<-80||sx>W+80||sy<-80||sy>H+80)continue;
    renderMob(c,sx,sy,mob);
  }

  // JOGADOR
  drawCharacter(c,W/2,H/2+20,G.player.class_id,G.moving?1.05:1,G.facing,G.moving?G.animTick:0);
  // Sombra do jogador
  c.fillStyle='rgba(0,0,0,.25)';c.beginPath();c.ellipse(W/2,H/2+26,16,5,0,0,Math.PI*2);c.fill();

  // Cursor
  if(!G.invOpen&&!G.craftOpen){
    c.strokeStyle='rgba(200,160,255,.5)';c.lineWidth=1.5;
    c.strokeRect(G.mouse.x-20,G.mouse.y-20,40,40);
    c.beginPath();c.moveTo(G.mouse.x-8,G.mouse.y);c.lineTo(G.mouse.x+8,G.mouse.y);c.moveTo(G.mouse.x,G.mouse.y-8);c.lineTo(G.mouse.x,G.mouse.y+8);c.stroke();
    c.lineWidth=1;
  }

  // Preview de construÃ§Ã£o
  if(G.selectedBuild&&!G.invOpen&&!G.craftOpen){
    const wx2=Math.floor((G.mouse.x+cam.x-W/2)/TILE),wy2=Math.floor((G.mouse.y+cam.y-H/2)/TILE);
    const sx=wx2*TILE-cam.x+W/2,sy=wy2*TILE-cam.y+H/2;
    c.globalAlpha=.5;c.fillStyle='#2a1840';c.fillRect(sx,sy,TILE,TILE);
    c.font=`${TILE*.6}px serif`;c.textAlign='center';c.textBaseline='middle';
    c.fillText(ITEMS_DB[G.selectedBuild]?.icon||'',sx+TILE/2,sy+TILE/2);c.globalAlpha=1;
  }

  // Overlay noite com vinheta
  if(G.dayPhase==='night'){
    const grd=c.createRadialGradient(W/2,H/2,60,W/2,H/2,Math.max(W,H)*.75);
    grd.addColorStop(0,'rgba(0,0,10,0)');grd.addColorStop(1,'rgba(0,0,20,.75)');
    c.fillStyle=grd;c.fillRect(0,0,W,H);
    // Estrelas durante a noite
    if(G.tick%2===0){
      c.fillStyle='rgba(255,255,255,.6)';
      for(let i=0;i<3;i++){
        const sx=Math.random()*W,sy=Math.random()*H*.2;
        c.beginPath();c.arc(sx,sy,1,0,Math.PI*2);c.fill();
      }
    }
  }

  // Vinheta RPG permanente
  const vig=c.createRadialGradient(W/2,H/2,Math.min(W,H)*.3,W/2,H/2,Math.max(W,H)*.7);
  vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(1,'rgba(0,0,0,.5)');
  c.fillStyle=vig;c.fillRect(0,0,W,H);

  // Minimap
  renderMinimap();
}

// â”€â”€ Renderiza estrutura no mundo â”€â”€
function renderStructure(c,sx,sy,st){
  const sw=st.def.w*TILE,sh=st.def.h*TILE;
  // Sombra
  c.fillStyle='rgba(0,0,0,.3)';c.fillRect(sx+8,sy+8,sw,sh);
  // Base
  if(st.def.id==='castle'){
    // Castelo detalhado
    c.fillStyle='#3a3040';c.fillRect(sx,sy,sw,sh);
    c.fillStyle='#2a2030';
    // Torres
    c.fillRect(sx,sy,TILE*2,TILE*3);c.fillRect(sx+sw-TILE*2,sy,TILE*2,TILE*3);
    c.fillRect(sx,sy+sh-TILE*2,TILE*2,TILE*2);c.fillRect(sx+sw-TILE*2,sy+sh-TILE*2,TILE*2,TILE*2);
    // Ameiamento
    for(let i=0;i<st.def.w;i+=1){c.fillStyle=i%2===0?'#4a4050':'#2a2030';c.fillRect(sx+i*TILE,sy,TILE,TILE*.4);}
    // Porta
    c.fillStyle='#1a1020';c.fillRect(sx+sw/2-TILE*.6,sy+sh-TILE*1.5,TILE*1.2,TILE*1.5);
    c.fillStyle='#8B6914';c.fillRect(sx+sw/2-TILE*.5,sy+sh-TILE*1.4,TILE,TILE*1.3);
    c.strokeStyle='#f0c040';c.lineWidth=1.5;c.strokeRect(sx,sy,sw,sh);
  } else if(st.def.id==='tower'){
    c.fillStyle='#2a2a3a';c.fillRect(sx,sy,sw,sh);
    c.fillStyle='#3a3a4a';
    for(let i=0;i<st.def.w;i++){c.fillStyle=i%2===0?'#4a4a5a':'#2a2a3a';c.fillRect(sx+i*TILE,sy,TILE,TILE*.5);}
    c.fillStyle='#1a1a28';c.fillRect(sx+TILE*.8,sy+sh-TILE*1.5,TILE*1.4,TILE*1.5);
    c.strokeStyle='#7060a0';c.lineWidth=1;c.strokeRect(sx,sy,sw,sh);
    // Janela com glow
    c.fillStyle='rgba(200,150,50,.4)';c.beginPath();c.arc(sx+sw/2,sy+sh/2,TILE*.4,0,Math.PI*2);c.fill();
  } else if(st.def.id==='cottage'||st.def.id==='house'){
    c.fillStyle='#5a3a18';c.fillRect(sx,sy+TILE*1.5,sw,sh-TILE*1.5);
    // Telhado
    c.fillStyle='#8B3a10';
    c.beginPath();c.moveTo(sx-TILE*.3,sy+TILE*1.5);c.lineTo(sx+sw/2,sy);c.lineTo(sx+sw+TILE*.3,sy+TILE*1.5);c.closePath();c.fill();
    // Janelas
    c.fillStyle='rgba(255,220,80,.3)';c.fillRect(sx+TILE*.5,sy+TILE*2,TILE*.8,TILE*.8);c.fillRect(sx+sw-TILE*1.3,sy+TILE*2,TILE*.8,TILE*.8);
    // Porta
    c.fillStyle='#3a1a08';c.fillRect(sx+sw/2-TILE*.4,sy+sh-TILE,TILE*.8,TILE);
    c.strokeStyle='#8B6914';c.lineWidth=1;c.strokeRect(sx,sy+TILE*1.5,sw,sh-TILE*1.5);
  } else if(st.def.id==='ruin'){
    c.fillStyle='#3a2a18';c.fillRect(sx,sy,sw,sh);
    // Paredes quebradas
    c.fillStyle='#2a1a10';c.fillRect(sx,sy+sh*.4,sw*.3,sh*.6);c.fillRect(sx+sw*.7,sy+sh*.2,sw*.3,sh*.8);
    c.strokeStyle='#5a3a20';c.lineWidth=1;c.setLineDash([4,4]);c.strokeRect(sx,sy,sw,sh);c.setLineDash([]);
  }
  // Ãcone
  c.font=`${TILE*1.2}px serif`;c.textAlign='center';c.textBaseline='bottom';
  c.fillText(st.def.icon,sx+sw/2,sy+sh*.3);
  // Nome
  c.font='bold 10px Cinzel,serif';c.fillStyle='rgba(240,192,0,.8)';c.textBaseline='bottom';
  c.fillText(st.def.name,sx+sw/2,sy-4);
  // Hint de interaÃ§Ã£o
  const dist=Math.hypot((sx+sw/2)-(G.W/2),(sy+sh/2)-(G.H/2));
  if(dist<120){
    c.fillStyle='rgba(240,192,0,.9)';c.font='bold 11px Cinzel,serif';c.textAlign='center';c.textBaseline='bottom';
    c.fillText('[F] ENTRAR',sx+sw/2,sy-16);
  }
}

// Paleta de mobs pixel art
const MOB_COLORS={
  sombrio:{body:'#2a1a3a',head:'#1a0a2a',eye:'#cc00ff',outline:'#4a2a5a'},
  ossalento:{body:'#e8e0d0',head:'#d8d0c0',eye:'#ff4400',outline:'#888070'},
  teianhas:{body:'#1a1a2a',head:'#0a0a1a',eye:'#44ff00',outline:'#333344'},
  estalador:{body:'#1a2a1a',head:'#0a1a0a',eye:'#44ff44',outline:'#2a3a2a'},
  voidwalker:{body:'#0a0a1a',head:'#040408',eye:'#8844ff',outline:'#1a1a3a'},
  gelado:{body:'#c0d8f0',head:'#a0c0e0',eye:'#00ccff',outline:'#8090b0'},
  magmavil:{body:'#3a1800',head:'#2a1000',eye:'#ff4400',outline:'#6a2800'},
  bruxalha:{body:'#2a0a3a',head:'#1a041a',eye:'#ff00aa',outline:'#4a1a5a'},
  dracozinho:{body:'#1a3010',head:'#0a2008',eye:'#ff8800',outline:'#2a4a20'},
  titanrock:{body:'#5a5a4a',head:'#4a4a3a',eye:'#ff2200',outline:'#3a3a2a'},
};
function renderMob(c,sx,sy,mob){
  mob.animTick=(mob.animTick||0)+1;
  const bob=Math.sin(mob.animTick*.12)*2;
  const cols=MOB_COLORS[Object.keys(MOB_TYPES).find(k=>MOB_TYPES[k].name===mob.name)||'sombrio']||MOB_COLORS.sombrio;
  c.save();c.translate(sx,sy+bob);
  // Sombra
  c.fillStyle='rgba(0,0,0,.3)';c.fillRect(-14,14,28,6);
  // Corpo pixel art
  c.fillStyle=cols.outline;c.fillRect(-12,-2,24,22);
  c.fillStyle=cols.body;c.fillRect(-10,0,20,18);
  // CabeÃ§a
  c.fillStyle=cols.outline;c.fillRect(-11,-18,22,18);
  c.fillStyle=cols.head;c.fillRect(-9,-16,18,14);
  // Olhos pixelados
  c.fillStyle=cols.eye;
  c.fillRect(-6,-13,4,4);c.fillRect(2,-13,4,4);
  c.fillStyle='rgba(255,255,255,.8)';
  c.fillRect(-5,-12,2,2);c.fillRect(3,-12,2,2);
  // Detalhes (chifres, dentes, etc baseado no tipo)
  if(mob.name==='Ossalento'){
    c.fillStyle='#fff0d0';
    c.fillRect(-8,18,4,8);c.fillRect(-2,18,4,8);c.fillRect(4,18,4,8);// ossos
  }
  if(mob.name==='Dracozinho'){
    c.fillStyle='#1a5010';
    c.fillRect(-16,-8,6,10);c.fillRect(10,-8,6,10);// asas
  }
  // Nome
  c.font='bold 8px "Press Start 2P",monospace';c.fillStyle=cols.eye;
  c.textAlign='center';c.textBaseline='bottom';
  c.fillText(mob.name,0,-22);
  c.restore();
  // HP bar pixel
  const bw=32;
  c.fillStyle='#330000';c.fillRect(sx-bw/2,sy-26,bw,5);
  c.fillStyle='#cc2222';c.fillRect(sx-bw/2,sy-26,bw*(mob.hp/mob.maxHp),5);
  c.strokeStyle='#550000';c.lineWidth=1;c.strokeRect(sx-bw/2,sy-26,bw,5);
}

// â”€â”€ Minimap â”€â”€
// var_border declarado acima
function renderMinimap(){
  const mm=G.mmctx,mw=144,mh=144;
  mm.clearRect(0,0,mw,mh);mm.fillStyle='#08050a';mm.fillRect(0,0,mw,mh);
  const scale=.6,ox=G.player.x/TILE-mw/(2*scale),oy=G.player.y/TILE-mh/(2*scale);
  for(let x=0;x<mw;x+=2)for(let y=0;y<mh;y+=2){
    const wx2=Math.floor(ox+x/scale),wy2=Math.floor(oy+y/scale);
    mm.fillStyle=getTileColor(wx2,wy2);mm.fillRect(x,y,2,2);
    if(isWaterTile(wx2,wy2)){mm.fillStyle='rgba(30,100,200,.5)';mm.fillRect(x,y,2,2);}
  }
  // Estruturas no minimap
  const chunks2=getVisibleChunks(G.player.x,G.player.y,mw*TILE/scale,mh*TILE/scale);
  for(const ch of chunks2)for(const st of ch.structs){
    const bx=(st.wx-ox)*scale,by=(st.wy-oy)*scale;
    if(bx<0||bx>mw||by<0||by>mh)continue;
    mm.fillStyle='rgba(240,192,0,.6)';mm.fillRect(bx-3,by-3,7,7);
  }
  for(const[,op]of G.otherPlayers){const bx=(op.x/TILE-ox)*scale,by=(op.y/TILE-oy)*scale;if(bx<0||bx>mw||by<0||by>mh)continue;mm.fillStyle='#4488ff';mm.fillRect(bx-2,by-2,5,5);}
  for(const mob of G.mobs){const bx=(mob.x/TILE-ox)*scale,by=(mob.y/TILE-oy)*scale;if(bx<0||bx>mw||by<0||by>mh)continue;mm.fillStyle='#ff4400';mm.fillRect(bx-1,by-1,3,3);}
  mm.fillStyle='#ff3300';mm.beginPath();mm.arc(mw/2,mh/2,4,0,Math.PI*2);mm.fill();
  mm.fillStyle='#fff';mm.beginPath();mm.arc(mw/2,mh/2,2,0,Math.PI*2);mm.fill();
  mm.strokeStyle='#4a2a6a';mm.lineWidth=2;mm.strokeRect(0,0,mw,mh);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameLoop(){
  if(!G.dead&&!document.hidden){
    update();
    if(!G.insideBuilding)render();
    else renderInterior();
  } else if(document.hidden){
    // Em background: roda lÃ³gica mÃ­nima mas nÃ£o renderiza
    G.tick++;G.animTick++;
    if(G.tick%60===0){
      const p=G.player;
      if(G.tick%600===0&&!G.onWater)p.water=Math.max(0,p.water-1);
      if(G.tick%300===0)p.hunger=Math.max(0,p.hunger-1);
    }
  }
  // Usa setTimeout para nÃ£o travar em segundo plano
  // Mas usa rAF quando visÃ­vel para sincronia com tela
  if(document.hidden){
    G._loopTimer=setTimeout(gameLoop,50);// 20fps em bg
  } else {
    G._loopRaf=requestAnimationFrame(gameLoop);
  }
}
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden){
    // Voltou ao foco: limpa timer e reinicia com rAF
    clearTimeout(G._loopTimer);
    // Limpa teclas presas que ficaram de quando saiu
    G.keys={};G.mouse.down=false;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELA DE LOGIN â€” decoraÃ§Ã£o
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initLoginScreen(){
  // Estrelas
  const stars=document.getElementById('lp-stars');
  for(let i=0;i<80;i++){
    const s=document.createElement('span');
    const size=Math.random()*2.5+.5;
    s.className='lp-star';
    s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*80}%;width:${size}px;height:${size}px;--d:${2+Math.random()*4}s;--del:${Math.random()*5}s`;
    stars.appendChild(s);
  }
  // Montanhas
  const mc=document.getElementById('lp-mountains');
  const mctx=mc.getContext('2d');
  mc.width=window.innerWidth;mc.height=220;
  const gradient=mctx.createLinearGradient(0,0,0,220);
  gradient.addColorStop(0,'rgba(30,15,50,.0)');gradient.addColorStop(1,'rgba(10,5,20,.95)');
  // Montanha de fundo
  mctx.fillStyle='#0f0820';
  mctx.beginPath();mctx.moveTo(0,220);
  for(let x=0;x<=mc.width;x+=30){const h=80+Math.sin(x*.008)*60+Math.sin(x*.02)*30;mctx.lineTo(x,220-h);}
  mctx.lineTo(mc.width,220);mctx.closePath();mctx.fill();
  // Montanha da frente
  mctx.fillStyle='#0a0518';
  mctx.beginPath();mctx.moveTo(0,220);
  for(let x=0;x<=mc.width;x+=20){const h=40+Math.sin(x*.012+1)*50+Math.sin(x*.03+2)*20;mctx.lineTo(x,220-h);}
  mctx.lineTo(mc.width,220);mctx.closePath();mctx.fill();
  mctx.fillStyle=gradient;mctx.fillRect(0,0,mc.width,220);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterGame(){
  const name=(document.getElementById('player-name-input').value.trim()||'Guerreiro').substring(0,18);
  G.playerName=name;
  // Se nÃ£o conectado, mostra aviso mas ENTRA ASSIM MESMO (modo offline)
  if(!G.connected){
    const badge=document.getElementById('online-badge');
    badge.textContent='âš  SEM SERVIDOR â€” MODO SOLO';
    badge.style.borderColor='#aa6600';badge.style.color='#ffaa00';
    // Tenta reconectar antes de entrar
    connectWS();
    setTimeout(()=>{
      if(!G.connected)console.log('[WARN] Entrando sem servidor');
    },500);
  }
  document.getElementById('login-screen').style.display='none';
  document.getElementById('hud').style.display='block';
  G.canvas=document.getElementById('gameCanvas');
  G.ctx=G.canvas.getContext('2d');
  G.mmc=document.getElementById('minimap');
  G.mmctx=G.mmc.getContext('2d');
  G.W=G.canvas.width=window.innerWidth;
  G.H=G.canvas.height=window.innerHeight;
  window.addEventListener('resize',()=>{G.W=G.canvas.width=window.innerWidth;G.H=G.canvas.height=window.innerHeight;});
  // Input
  window.addEventListener('keydown',e=>{
    // Normaliza a tecla: armazena versÃ£o minÃºscula + original
    // Isso resolve CapsLock, Shift etc para teclas de movimento
    const k=e.key;
    const kl=k.toLowerCase();
    G.keys[k]=true;
    G.keys[kl]=true;// sempre marca tambÃ©m o lower
    if(k>='1'&&k<='9'){G.hotbarIdx=parseInt(k)-1;updateHotbarUI();}
    if(k==='0'){G.hotbarIdx=9;updateHotbarUI();}
    if(kl==='e'&&!G.craftOpen&&!G.buildOpen)toggleInventory();
    if(kl==='c'&&!G.invOpen&&!G.buildOpen)toggleCraft();
    if(kl==='b'&&!G.invOpen&&!G.craftOpen)toggleBuild();
    if(kl==='f')tryInteractKey();
    if(k==='Escape'){
      if(G.chestOpen)closeChest();
      else if(G.insideBuilding)exitBuilding();
      else if(G.invOpen)toggleInventory();
      else if(G.craftOpen)toggleCraft();
      else if(G.buildOpen)toggleBuild();
    }
    if(kl==='t'&&!G.invOpen&&!G.craftOpen){document.getElementById('chat-input').focus();e.preventDefault();}
  });
  window.addEventListener('keyup',e=>{
    G.keys[e.key]=false;
    G.keys[e.key.toLowerCase()]=false;
  });
  // Limpa todas as teclas ao perder o foco (evita "tecla presa")
  window.addEventListener('blur',()=>{G.keys={};G.mouse.down=false;});
  G.canvas.addEventListener('mousemove',e=>{G.mouse.x=e.clientX;G.mouse.y=e.clientY;});
  G.canvas.addEventListener('mousedown',e=>{G.mouse.down=true;if(G.invOpen||G.craftOpen)return;if(G.selectedBuild){const wx=Math.floor((e.clientX+G.camera.x-G.W/2)/TILE),wy=Math.floor((e.clientY+G.camera.y-G.H/2)/TILE);placeBlock(wx,wy);}else{tryInteract();}});
  G.canvas.addEventListener('mouseup',()=>{G.mouse.down=false;});
  G.canvas.addEventListener('wheel',e=>{G.hotbarIdx=(G.hotbarIdx+(e.deltaY>0?1:-1)+10)%10;updateHotbarUI();});
  document.getElementById('chat-input').addEventListener('keydown',e=>{if(e.key==='Enter'){sendChat();document.getElementById('chat-input').blur();e.preventDefault();}if(e.key==='Escape')document.getElementById('chat-input').blur();e.stopPropagation();});
  G.playerName=name;
  if(G.connected){wsSend({type:'join',name});}
  // Se nÃ£o conectado, o join serÃ¡ enviado no onopen (reconexÃ£o)
  spawnMobs(8);
  updateHotbarUI();
  if(!G._loopStarted){
    G._loopStarted=true;
    gameLoop();
  }
}

document.getElementById('player-name-input').addEventListener('keydown',e=>{if(e.key==='Enter')enterGame();});
initLoginScreen();
connectWS();
// Atualiza badge com progresso de conexÃ£o
let _connTry=0;
const _connInterval=setInterval(()=>{
  _connTry++;
  const badge=document.getElementById('online-badge');
  if(!badge)return;
  if(G.connected){clearInterval(_connInterval);return;}
  const dots='.'.repeat(_connTry%4);
  badge.textContent=`Â» CONECTANDO${dots} Â«`;
  if(_connTry>10&&!G.connected){
    badge.textContent='âš  SERVIDOR OFFLINE â€” MODO SOLO';
    badge.style.color='#ffaa44';badge.style.borderColor='#6a4400';
    clearInterval(_connInterval);
  }
},500);

</script>

<!-- â•â•â•â•â•â•â•â•â•â• PIXEL ART RENDERER EXTRA â•â•â•â•â•â•â•â•â•â• -->
<script>
// Cursor pixel art
(function(){
  const cv=document.getElementById('cursor');
  const ctx=cv.getContext('2d');
  // Desenha cursor de espada pixel
  const p=[[0,0],[1,0],[0,1],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[4,6],[6,4],[3,7],[7,3]];
  ctx.fillStyle='#f0d060';
  p.forEach(([x,y])=>ctx.fillRect(x,y,1,1));
  ctx.fillStyle='#fff';
  [[2,2],[3,3],[4,4]].forEach(([x,y])=>ctx.fillRect(x,y,1,1));
  document.addEventListener('mousemove',e=>{
    const c=document.getElementById('cursor');
    c.style.left=e.clientX+'px';c.style.top=e.clientY+'px';
  });
})();

// Login background â€” pixel art world preview
(function initLoginBg(){
  const cv=document.getElementById('login-bg-canvas');
  if(!cv)return;
  cv.width=window.innerWidth;cv.height=window.innerHeight;
  const ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  const TS=32;// tile size para o bg
  // Paleta de tiles simples
  const TILES={
    G:['#487a20','#5a9a28','#3a6018'],// grama
    W:['#2a70a0','#1a5080','#3a80b0'],// Ã¡gua
    S:['#787870','#9a9a8a','#585850'],// pedra
    D:['#c8a850','#e0c878','#a88838'],// deserto
    F:['#1a4a1a','#2a5a2a','#1a3a0a'],// floresta escura
  };
  const pattern=['G','G','G','F','F','F','G','G','W','W','G','G','G','D','D','G','G','F','F','G'];
  function getTile(x,y){return pattern[(x+y*3)%pattern.length]}
  for(let ty=0;ty<Math.ceil(H/TS)+1;ty++){
    for(let tx=0;tx<Math.ceil(W/TS)+1;tx++){
      const t=getTile(tx,ty);
      const cols=TILES[t];
      ctx.fillStyle=cols[(tx+ty)%cols.length];
      ctx.fillRect(tx*TS,ty*TS,TS,TS);
      // Grade sutil
      ctx.strokeStyle='rgba(0,0,0,.1)';ctx.lineWidth=1;
      ctx.strokeRect(tx*TS,ty*TS,TS,TS);
    }
  }
  // Overlay escuro gradiente para legibilidade
  const grd=ctx.createRadialGradient(W/2,H/2,80,W/2,H/2,Math.max(W,H)*.7);
  grd.addColorStop(0,'rgba(10,8,2,.5)');grd.addColorStop(1,'rgba(0,0,0,.92)');
  ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
  // Pequenas Ã¡rvores decorativas
  const trees=[[.15,.2],[.8,.15],[.25,.75],[.7,.8],[.5,.35],[.35,.6],[.65,.5]];
  trees.forEach(([fx,fy])=>{
    const tx2=fx*W,ty2=fy*H;
    ctx.fillStyle='#2a4a1a';ctx.fillRect(tx2-8,ty2-20,16,24);
    ctx.fillStyle='#1a3a0a';ctx.fillRect(tx2-12,ty2-36,24,20);
    ctx.fillStyle='#2a5a1a';ctx.fillRect(tx2-10,ty2-50,20,18);
    ctx.fillStyle='#6b3a10';ctx.fillRect(tx2-4,ty2+4,8,12);
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIXEL ART TILE RENDERER
// Substitui getTileColor por tiles desenhados
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Paleta de cores pixel art por bioma
const BIOME_PALETTE = {
  PLAINS:  {base:'#487a20',var1:'#5a9a28',var2:'#3a6018',accent:'#60aa30',detail:'#386018'},
  FOREST:  {base:'#1e5010',var1:'#2a6018',var2:'#163808',accent:'#386028',detail:'#0e2808'},
  DESERT:  {base:'#c8a850',var1:'#e0c878',var2:'#a88838',accent:'#d8b860',detail:'#886820'},
  SNOW:    {base:'#c8d8e8',var1:'#d8e8f8',var2:'#a8b8c8',accent:'#e8f4ff',detail:'#88a0b8'},
  JUNGLE:  {base:'#1a5a1a',var1:'#228822',var2:'#0e4010',accent:'#30aa30',detail:'#0a2808'},
  SAVANNA: {base:'#9a8030',var1:'#b09040',var2:'#786010',accent:'#c0a048',detail:'#584810'},
  TAIGA:   {base:'#2a4a2a',var1:'#386038',var2:'#1a3018',accent:'#4a7040',detail:'#102010'},
  MUSHROOM:{base:'#5a1a4a',var1:'#7a2a6a',var2:'#3a0a2a',accent:'#8a3a7a',detail:'#200818'},
  RIVER:   {base:'#2a70a0',var1:'#3a88c0',var2:'#1a5080',accent:'#50a0d0',detail:'#104060'},
  OCEAN:   {base:'#1a4a7a',var1:'#2a5a9a',var2:'#0a3060',accent:'#3a70b0',detail:'#082040'},
  LAKE:    {base:'#2058a0',var1:'#3070b8',var2:'#104080',accent:'#4088c8',detail:'#083060'},
  SWAMP:   {base:'#2a3a1a',var1:'#3a4a28',var2:'#1a2810',accent:'#304820',detail:'#101808'},
};

// Render tiles com pixel art real (padrÃ£o de ruÃ­do)
function renderPixelTile(ctx, sx, sy, wx, wy, tileSize) {
  const biome = getBiome(wx, wy);
  const pal = BIOME_PALETTE[biome] || BIOME_PALETTE.PLAINS;
  // Hash simples para variaÃ§Ã£o de cor
  const h = ((wx * 374761393 + wy * 1234567891) >>> 0) % 100;
  const isWater = BIOMES[biome]?.water;

  // Cor base
  const baseCol = h < 50 ? pal.base : h < 80 ? pal.var1 : pal.var2;
  ctx.fillStyle = baseCol;
  ctx.fillRect(sx, sy, tileSize, tileSize);

  // Detalhes pixel (pequenas variaÃ§Ãµes a cada 8px)
  const ps = Math.max(2, Math.floor(tileSize / 6)); // pixel size
  for (let py = 0; py < tileSize; py += ps) {
    for (let px2 = 0; px2 < tileSize; px2 += ps) {
      const ph = ((wx * tileSize + px2) * 1234567 + (wy * tileSize + py) * 7654321) >>> 0;
      if (ph % 7 === 0) {
        ctx.fillStyle = pal.detail;
        ctx.fillRect(sx + px2, sy + py, ps, ps);
      } else if (ph % 11 === 0) {
        ctx.fillStyle = pal.accent;
        ctx.fillRect(sx + px2, sy + py, ps, ps);
      }
    }
  }

  // AnimaÃ§Ã£o da Ã¡gua
  if (isWater) {
    const waveOff = Math.sin((G.tick || 0) * 0.06 + wx * 0.4 + wy * 0.3) * 0.25 + 0.6;
    ctx.fillStyle = `rgba(80,160,220,${waveOff * 0.35})`;
    ctx.fillRect(sx, sy, tileSize, tileSize);
    // Linhas de onda
    ctx.strokeStyle = `rgba(180,220,255,${waveOff * 0.25})`;
    ctx.lineWidth = Math.max(1, tileSize / 16);
    const waveY = sy + tileSize * 0.4 + Math.sin((G.tick || 0) * 0.1 + wx) * tileSize * 0.08;
    ctx.beginPath();
    ctx.moveTo(sx + tileSize * 0.1, waveY);
    ctx.bezierCurveTo(sx + tileSize * 0.3, waveY - tileSize * 0.08,
                       sx + tileSize * 0.7, waveY + tileSize * 0.08,
                       sx + tileSize * 0.9, waveY);
    ctx.stroke();
  }

  // Grid de tiles sutil
  ctx.strokeStyle = 'rgba(0,0,0,0.08)';
  ctx.lineWidth = 1;
  ctx.strokeRect(sx, sy, tileSize, tileSize);
}

// Sobrescreve a funÃ§Ã£o de renderizaÃ§Ã£o de tiles no gameLoop
const _origRender = window.render;
if(typeof render === 'function'){
  // Patch aplicado apÃ³s carregamento do game_logic
}
</script>
</body>
</html>
